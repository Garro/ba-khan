{% extends 'home.html' %}
{% load static %}
{% load  smart_if %}

{% block title %}
Nomina
{% endblock %}

{% block body2 %}
<script src="{% static 'js/editablegrid.js' %}"></script>
<script src="{% static 'js/editablegrid_renderers.js' %}"></script>
<script src="{% static 'js/editablegrid_editors.js' %}"></script>
<script src="{% static 'js/editablegrid_validators.js' %}"></script>
<script src="{% static 'js/editablegrid_utils.js' %}"></script>
<script src="{% static 'js/editablegrid_charts.js' %}"></script>
<script src="{% static 'js/stickytable.js' %}"></script>
<script type="text/javascript" src="{% static 'js/jquery.nicescroll.min.js' %}"></script>

<link rel="stylesheet" type="text/css" href="{% static 'css/editablegrid.css'%}">
<link rel="stylesheet" type="text/css" href="{% static 'css/classRoster.css'%}">

<br>
<div class="container">
<div class="main-content">
	<div id="classesDiv">
		<h1 style="margin-top:1%">Ver Cursos</h1>
		<label for="selectClass">Curso: </label>
		<select id="selectClass" class="ui-corner-all placeholder simple-input blur-on-esc">
			{% for class in classes %}
			{% if class.level > 8 %}
				{% if class.additional %}
				<option value="{{class.id_class}},{{class.level}}.{{class.letter}}-{{class.year}}_{{class.additional}}">{{class.level|add:-8}} Medio {{class.letter}} {{class.year}} {{class.additional}} </option>
				{% else %}
				<option value="{{class.id_class}},{{class.level}}.{{class.letter}}-{{class.year}}_">{{class.level|add:-8}} Medio {{class.letter}} {{class.year}} </option>
				{% endif %}
			{% else %}
				{% if class.additional %}
				<option value="{{class.id_class}},{{class.level}}.{{class.letter}}-{{class.year}}_{{class.additional}}">{{class.level}} Básico {{class.letter}} {{class.year}} {{class.additional}} </option>
				{% else %}
				<option value="{{class.id_class}},{{class.level}}.{{class.letter}}-{{class.year}}_">{{class.level}} Básico {{class.letter}} {{class.year}} </option>
				{% endif %}
			{% endif %}
			{% endfor %}
		</select>
		<a onclick="javascript:viewClass()" id="viewClassButton" class="kui-button kui-button-plain kui-button-primary">Ver Curso</a>
	</div>

<br>
<h1 style="padding-top: 125px;">Crear Curso</h1>

	<div id="teachersDiv">
		<h3>Seleccionar Profesor</h3>
		<label for="searchTeacher">Buscar: </label><input type="text" id="searchTeacher" class="ui-corner-all placeholder simple-input search-input blur-on-esc"/>
		<div class="teacherTable">
			<table id="teachergrid" class="testgrid">
				<tr>
					<th>Profesor</th>
				</tr>
				<tr>
					<td>
						<label for="newTeacher">Nuevo profesor: </label>
						<input id="newTeacher" value="" class="ui-corner-all placeholder simple-input blur-on-esc"></input>
				<a onclick="javascript:newTeacherClass()" id="newTeacherButton" style="color:#56861f;"><i class="plus"></i></a>
					</td>
				</tr>
				{% for teacher in teachers %}
				<tr id="R{{ forloop.counter }}" >
					<td><label><input type="radio" name="radioTeachers" value="{{ teacher }}" id="{{ teacher }}"> {{ teacher }}</label></td>
				</tr>
				{% endfor %}
				
			</table>
			
		</div>
	</div>

	<div id="studentsDiv">
		<h3>Seleccionar Estudiantes</h3>
		<label for="searchStudent">Buscar: </label><input type="text" id="searchStudent" class="ui-corner-all placeholder simple-input search-input blur-on-esc"/>
		<div class="studentTable">

			<table id="studentgrid" class="testgrid">
				<tr>
					<th>Estudiantes</th>
				</tr>
				
				{% for student in students %}
				<tr id="R{{ forloop.counter }}" >
					<td><input type="checkbox" id="student{{ forloop.counter }}" value="{{ student }}"></input><label for="student{{ forloop.counter }}">{{ student }}</label></td>
				</tr>
				{% endfor %}
				
			</table>

		</div>
	</div>

	<div id="classDiv">
		<h3>Curso</h3>
		<label for="levels">Nivel: </label>
		<select id="levels" class="ui-corner-all placeholder simple-input blur-on-esc">
			<option value="1">1° Básico</option>
			<option value="2">2° Básico</option>
			<option value="3">3° Básico</option>
			<option value="4">4° Básico</option>
			<option value="5">5° Básico</option>
			<option value="6">6° Básico</option>
			<option value="7">7° Básico</option>
			<option value="8">8° Básico</option>
			<option value="9">1° Medio</option>
			<option value="10">2° Medio</option>
			<option value="11">3° Medio</option>
			<option value="12">4° Medio</option>
		</select>
		<label for="letter">Letra: </label>
		<select id="letter" class="ui-corner-all placeholder simple-input blur-on-esc">
			<option value="A">A</option>
			<option value="B">B</option>
			<option value="C">C</option>
			<option value="D">D</option>
			<option value="E">E</option>
			<option value="F">F</option>
			<option value="G">G</option>
		</select>
		<label for="year">Año: </label>
		<input type="number" id="year" min="2016" value="2016" class="ui-corner-all placeholder simple-input blur-on-esc"></input>
		<br>
		<label for="additional">Adicional: </label>
		<input type="text" id="additional" placeholder="Opcional" class="ui-corner-all placeholder simple-input blur-on-esc"></input>
		<label for="teacher">Profesor: </label>
		<input id="teacher" value="" disabled class="ui-corner-all placeholder simple-input blur-on-esc"></input> <br>
		<h5>Estudiantes: <p id="counter">0</p></h5>
		
		<div id="studentsClass"></div>
		<a onclick="javascript:resetClass()" id="resetButton" class="kui-button kui-button-plain kui-button-primary">Reestablecer</a>
		<a onclick="javascript:confirmSaveClass()" id="confirmSaveButton" class="kui-button kui-button-plain kui-button-primary">Guardar</a>
		<a onclick="javascript:confirmEditClass()" id="confirmEditButton" class="kui-button kui-button-submit kui-button-primary" style="display:none">Editar</a>
	</div>

</div>
<br>
</div>

<div id="popup" style="display:none">
	<div id="close">X</div>
</div>
<br>

	<div style="display: none;" id="loading" class="profile-throbber">
		<div class="throbber-grid">   
   			    <div class="throbber-row clearfix">
		         <div class="block-0 throbber-block"></div>
		         <div class="block-1 throbber-block"></div>
		         <div class="block-2 throbber-block"></div>
		    </div>
		    <div class="throbber-row clearfix">
		         <div class="block-7 throbber-block"></div>
		         <div class="block-8 throbber-block"></div>
		         <div class="block-3 throbber-block"></div>
		    </div>
		    <div class="throbber-row clearfix">
		         <div class="block-6 throbber-block"></div>
		         <div class="block-5 throbber-block"></div>
		         <div class="block-4 throbber-block"></div>
		    </div>
		</div>
	</div>

</div> <!-- cerrar div principal del home  -->

<script type="text/javascript">
$('#nomina').addClass('active selected'); 

$(document).ready(function(){
	$("#hover").click(function(){
	    $(this).fadeOut();
		$("#popup").fadeOut();
	});
	$("#close").click(function(){
	    $("#hover").fadeOut();
		$("#popup").fadeOut();
	});

	$(".studentTable").niceScroll({ cursorwidth:'10px', autohidemode: false, cursorcolor:'#D9D9D9', zindex:10, railoffset: { left: 12} });
	$("#studentsClass").niceScroll({ cursorwidth:'10px', autohidemode: true, cursorcolor:'#D9D9D9', zindex:10 });
	$(".teacherTable").niceScroll({ cursorwidth:'10px', autohidemode: false, cursorcolor:'#D9D9D9', zindex:10, railoffset: { left: 12} });


	// Write on keyup event of keyword input element
	$("#searchStudent").keyup(function(){
		// When value of the input is not blank
		if( $(this).val() != "")
		{
			// Show only matching TR, hide rest of them
			$("#studentgrid tbody>tr").hide();
			$("#studentgrid td:contains-ci('" + $(this).val() + "')").parent("tr").show();
		}
		else
		{
			// When there is no input or clean again, show everything back
			$("#studentgrid tbody>tr").show();
		}
	});

	$("#searchTeacher").keyup(function(){
		// When value of the input is not blank
		if( $(this).val() != "")
		{
			// Show only matching TR, hide rest of them
			$("#teachergrid tbody>tr").hide();
			$("#teachergrid td:contains-ci('" + $(this).val() + "')").parent("tr").show();
		}
		else
		{
			// When there is no input or clean again, show everything back
			$("#teachergrid tbody>tr").show();
		}
	});

	$('input[type="checkbox"]').click(function(){
	    if($(this).is(":checked")){
	    	$("#studentsClass").append("<div id=div"+$(this)[0].id+" class='student_li_div'><li id='"+$(this).val()+"' class='student_li'>"+$(this).val()+"</li><a id='uncheckStudent' onclick='javascript:uncheckStudent("+$(this)[0].id+")'>X</a></div>");
	    	var studentsLen = $("li").length;
	    	$("#counter").html(studentsLen);
	    }
	    else if($(this).is(":not(:checked)")){
	        var child = document.getElementById($(this).val());
	        $(child).closest('div').remove();
	        var studentsLen = $("li").length;
	    	$("#counter").html(studentsLen);
	    }
	});

	$('input[type="radio"]').click(function(){
        if($(this).is(":checked")){
            $("#teacher").val($(this).val());
        }
    });

    resetClass();
});

// jQuery expression for case-insensitive filter
$.extend($.expr[":"], 
{
    "contains-ci": function(elem, i, match, array) 
	{
		return (elem.textContent || elem.innerText || $(elem).text() || "").toLowerCase().indexOf((match[3] || "").toLowerCase()) >= 0;
	}
});

var classJson = new Object();
function confirmSaveClass(){
	classJson.additional = $("#additional").val();
	classJson.year = $("#year").val();
	if (classJson.year<2016){
		$('.response').remove();
		$("#hover").fadeIn();
		$("#popup").fadeIn();
		$("#popup").append("<p class='response'>Año inválido</p>");
		return;
	}
	classJson.teacher = $("#teacher").val();
	if (classJson.teacher==""){
		$('.response').remove();
		$("#hover").fadeIn();
		$("#popup").fadeIn();
		$("#popup").append("<p class='response'>Falta escoger profesor</p>");
		return;
	}
	classJson.level = $("#levels").val();
	classJson.letter = $("#letter").val();
	var studentsArray = [];
	$("li").each(function (index){ 
		studentsArray.push($(this).html());
	});
	classJson.students = studentsArray;
	if (classJson.students.length == 0){
		$('.response').remove();
		$("#hover").fadeIn();
		$("#popup").fadeIn();
		$("#popup").append("<p class='response'>Falta escoger estudiantes</p>");
		return;
	}

	var studentsLen = $("li").length;
	levels = ["","1°","2°","3°","4°","5°","6°","7°","8°","1°","2°","3°","4°"]
	if (classJson.level>0 && classJson.level<9){
		level = levels[classJson.level]+" Básico "
	}
	else{
		level = levels[classJson.level]+" Medio "
	}

	$(".response").remove()
	$("#popup").append("<p class='response'>¿Está seguro que desea guardar el curso "+level+classJson.letter+" "+classJson.year+" a cargo del profesor "+classJson.teacher+" con "+studentsLen+" estudiantes?</p>");
	$("#popup").append('<button onclick="javascript:saveClass(classJson)" id="saveButton" class="kui-button kui-button-plain kui-button-primary">Aceptar</button>');
	$("#popup").append('<button onclick="javascript:cancelSaveClass()" id="cancelSaveButton" class="kui-button kui-button-plain kui-button-primary">Cancelar</button>');
	$("a").css('pointer-events','none');
	$("#hover").css('pointer-events','none');
	$("#close").css('pointer-events','none');
	$("#hover").fadeIn();
	$("#popup").fadeIn();
}

function cancelSaveClass(){
	$("#hover").fadeOut();
	$("#popup").fadeOut();
	$(".response").remove();
	$("#saveButton").remove();
	$("#editButton").remove();
	$("#cancelSaveButton").remove();
	$("#hover").css('pointer-events','');
	$("#close").css('pointer-events','');
	$("a").css('pointer-events','');
}

function saveClass(classJson){
	$(".response").remove();
	$("#saveButton").remove();
	$("#cancelSaveButton").remove();
	$("#popup").append("<p class='response'>Guardando el curso. Espere un momento por favor...</p>");
	$("#popup").append($('#loading').css('display',''));
	$("#hover").css('pointer-events','none');
	$("#close").css('pointer-events','none');
	$("#hover").fadeIn();
	$("#popup").fadeIn();
	$.ajax({
		url: "{% url 'classRoster:newClass' %}",
		type: "POST",
		data: classJson,
			success: function(response){
				$(".response").fadeOut();
				$('#loading').fadeOut();
				$(".response").remove()
				$("#popup").append("<p class='response' style='display:none'>"+response+"</p>");
				$(".response").fadeIn();
				setTimeout(function(){
					location.reload();
				}, 750); 
			}
	});
}

function resetClass(){
	$("input:checkbox").each(function (index){ 
		$(this).prop("checked",false);
	});
	$("input:radio").each(function (index){ 
		$(this).prop("checked",false);
	});
	$("li").each(function (index){ 
		$(this).remove();
	});
	$("#teacher").val("");
	$("#levels").val(1); $("#levels").prop('disabled', false);
	$("#letter").val("A"); $("#letter").prop('disabled', false);
	$("#year").val(2016); $("#year").prop('disabled', false);
	$("#additional").val(null); $("#additional").prop('disabled', false);
	var studentsLen = $("li").length;
	$("#counter").html(studentsLen);

	$("#confirmSaveButton").show();
	$("#confirmEditButton").hide();

	$(".student_li_div").each(function (index){ 
		$(this).remove();
	})
}

function newTeacherClass(){
	var newTeacher = new Object();
	newTeacher.username = $("#newTeacher").val();
	if (newTeacher.username==""){
		$('.response').remove();
		$("#hover").fadeIn();
		$("#popup").fadeIn();
		$("#popup").append("<p class='response'>Ingrese nombre de usuario de KhanAcademy del profesor a buscar.</p>");
		return;
	}
	else{
		$(".response").remove()
		$("#popup").append("<p class='response'>Buscando al profesor. Espere un momento por favor...</p>");
		$("#popup").append($('#loading').css('display',''));
		$("#hover").css('pointer-events','none');
		$("#close").css('pointer-events','none');
		$("a").css('pointer-events','none');
		$("#hover").fadeIn();
		$("#popup").fadeIn();
		$.ajax({
			url: "{% url 'classRoster:newTeacherClass' %}",
			type: "POST",
			data: newTeacher,
				success: function(response){
					$(".response").fadeOut();
					$('#loading').fadeOut();
					$(".response").remove()
					$("#popup").append("<p class='response' style='display:none'>"+response+"</p>");
					$(".response").fadeIn();
					if (response=="Nuevo profesor creado."){
						setTimeout(function(){
							document.location.reload(true);
						}, 750); 
					}
					else{
						$("#hover").css('pointer-events','');
						$("#close").css('pointer-events','');
						$("a").css('pointer-events','');
					}
				}
		});
	}
}
var id_class;
function viewClass(){
	resetClass();
	$(".response").remove();
	$("#popup").append("<p class='response'>Cargando el curso. Espere un momento por favor...</p>");
	$("#popup").append($('#loading'));
	$('#loading').show();
	$("#hover").css('pointer-events','none');
	$("#close").css('pointer-events','none');
	$("#hover").fadeIn();
	$("#popup").fadeIn();

	
	$("#confirmSaveButton").css('display','none');
	$("#confirmEditButton").css('display','');

	selectClass = $("#selectClass").val();
	
	id_class = selectClass.substring(0,selectClass.indexOf(","))
	var level = selectClass.substring(selectClass.indexOf(",")+1,selectClass.indexOf("."))
	var letter = selectClass.substring(selectClass.indexOf(".")+1,selectClass.indexOf("-"))
	var year = selectClass.substring(selectClass.indexOf("-")+1,selectClass.indexOf("_"))
	var additional = selectClass.substring(selectClass.indexOf("_")+1,selectClass.length)
	if (additional==""){additional=" "}

	var classObj = new Object();
	classObj.idClass = id_class;
	$.ajax({
			url: "{% url 'classRoster:viewClass' %}",
			type: "POST",
			data: classObj,
			dataType: "json",
			success: function(response){
				for (a=0;a<response.length-1;a++){
					$("input:checkbox[value='"+response[a]['fields']['name']+"']").prop("checked", true);
					$("#studentsClass").append("<div id=std"+(a+1)+" class='student_li_div'><li id='"+response[a]['fields']['name']+"' class='student_li'>"+response[a]['fields']['name']+"</li><a onclick='javascript:uncheckStudent2(std"+(a+1)+")' id='uncheckStudent'>X</a></div>");

					$("#levels").val(level); // $("#levels").prop('disabled', true);
					$("#letter").val(letter); // $("#letter").prop('disabled', true);
					$("#year").val(year); // $("#year").prop('disabled', true);
					$("#additional").val(additional); // $("#additional").prop('disabled', true);
					var studentsLen = $("li").length;
					$("#counter").html(studentsLen);
				}
				$("input:radio[value='"+response[response.length-1][0]['fields']['name']+"']").prop("checked", true);
				$("#teacher").val(response[response.length-1][0]['fields']['name']);
			
				setTimeout(function(){
					$(".response").remove();
					$('#loading').css('display','none');
					$("#hover").css('pointer-events','');
					$("#close").css('pointer-events','');
					$("#hover").fadeOut();
					$("#popup").fadeOut();
				}, 750); 
			}
		});

/*
	*/ 
	
}

function confirmEditClass(){
	classJson.idClass = id_class;
	classJson.additional = $("#additional").val();
	if (classJson.additional == " "){ classJson.additional=null}
	classJson.year = $("#year").val();
	if (classJson.year<2016){
		$('.response').remove();
		$("#hover").fadeIn();
		$("#popup").fadeIn();
		$("#popup").append("<p class='response'>Año inválido</p>");
		return;
	}
	classJson.teacher = $("#teacher").val();
	if (classJson.teacher==""){
		$('.response').remove();
		$("#hover").fadeIn();
		$("#popup").fadeIn();
		$("#popup").append("<p class='response'>Falta escoger profesor</p>");
		return;
	}
	classJson.level = $("#levels").val();
	classJson.letter = $("#letter").val();
	var studentsArray = [];
	$("li").each(function (index){ 
		studentsArray.push($(this).html());
	});
	classJson.students = studentsArray;
	if (classJson.students.length == 0){
		$('.response').remove();
		$("#hover").fadeIn();
		$("#popup").fadeIn();
		$("#popup").append("<p class='response'>Falta escoger estudiantes</p>");
		return;
	}

	var studentsLen = $("li").length;
	levels = ["","1°","2°","3°","4°","5°","6°","7°","8°","1°","2°","3°","4°"]
	if (classJson.level>0 && classJson.level<9){
		level = levels[classJson.level]+" Básico "
	}
	else{
		level = levels[classJson.level]+" Medio "
	}

	$(".response").remove()
	$("#popup").append("<p class='response'>¿Está seguro que desea editar el curso "+level+classJson.letter+" "+classJson.year+" a cargo del profesor "+classJson.teacher+" con "+studentsLen+" estudiantes?</p>");
	$("#popup").append('<button onclick="javascript:editClass(classJson)" id="editButton" class="kui-button kui-button-plain kui-button-primary">Aceptar</button>');
	$("#popup").append('<button onclick="javascript:cancelSaveClass()" id="cancelSaveButton" class="kui-button kui-button-plain kui-button-primary">Cancelar</button>');
	$("a").css('pointer-events','none');
	$("#hover").css('pointer-events','none');
	$("#close").css('pointer-events','none');
	$("#hover").fadeIn();
	$("#popup").fadeIn();
}

function editClass(classJson){
	$(".response").remove();
	$("#editButton").remove();
	$("#cancelSaveButton").remove();
	$("#popup").append("<p class='response'>Guardando el curso. Espere un momento por favor...</p>");
	$("#popup").append($('#loading').css('display',''));
	$("#hover").css('pointer-events','none');
	$("#close").css('pointer-events','none');
	$("#hover").fadeIn();
	$("#popup").fadeIn();
	$.ajax({
		url: "{% url 'classRoster:editClass' %}",
		type: "POST",
		data: classJson,
			success: function(response){
				$(".response").fadeOut();
				$('#loading').fadeOut();
				$(".response").remove()
				$("#popup").append("<p class='response' style='display:none'>"+response+"</p>");
				$(".response").fadeIn();
				setTimeout(function(){
					location.reload();
				}, 750); 
			}
	});
	
}

function uncheckStudent(student){
	var std = $(student);
	$("input:checkbox[value='"+std[0].value+"']").prop("checked", false);
	$("#div"+std[0].id).remove();
	var studentsLen = $("li").length;
	$("#counter").html(studentsLen);
}

function uncheckStudent2(student){
	$("input:checkbox[value='"+$(student)[0].children[0].innerText+"']").prop("checked", false);
	$(student).remove();
	var studentsLen = $("li").length;
	$("#counter").html(studentsLen);
}

</script>

{% endblock %}