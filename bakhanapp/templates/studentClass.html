{% extends 'home.html' %}
{% load static %}
{% load  smart_if %}

{% block title %}
	Dashboard
{% endblock %}
{% block body2 %}		
	
	<div id="popup" style="display:none">
    	<div id="close">X</div>
    	<div style="align:left;">
	    	<form action="" method="post" id='formGrade'>{% csrf_token %}
				<p style="margin:0px;">
					Nombre Estudiante
					<input name="input_grade_nombre" id="input_grade_nombre" class="ui-corner-all placeholder simple-input search-input blur-on-esc vaciar" type="text" style="align:left;"/>
					<input name="input_grade_id" id="input_id_grade" class="vaciar" type="text" style="display:none;"/>
					Nota:
					<input name="input_grade" id="input_grade" class="ui-corner-all placeholder simple-input search-input blur-on-esc vaciar" type="text" style="align:left;width:30px;padding:5px"/>
					Nota Profesor
					<input name="input_grade_teacher" id="input_grade_comment" class="ui-corner-all placeholder simple-input search-input blur-on-esc vaciar" type="text" style="align:left;width:30px;padding:5px"/>
				</p>
				<p style="margin-top:10px;margin-bottom:0px;">Comentario
					<textarea id="textarea_coment" class="ui-corner-all placeholder simple-input search-input blur-on-esc vaciar" style="width:550px;height:50px;padding-top:5px"></textarea>
					<input name="input_comment" class="vaciar" id="input_comment" type="text" style="display:none;"/>
				</p>
			</form>
			<div><input type="button" onClick="modificarNota()" class="kui-button kui-button-plain kui-button-primary" value="Modificar Nota"></div>
    	</div>
    </div>
	
	<div style="margin:10px"><button class="kui-button kui-button-plain kui-button-primary" onclick="nuevaEvaluacion()">Nueva Evaluacion</button></div>
	<div id="contenido_a_mostrar" style="display:none;">
			<div id="inputs" align="left">
				<select id="comboBox" style="margin:10px;" onChange="fillParameters(this.value)">
					<OPTION VALUE=0>Seleccionar Pauta</OPTION>
					{% for config in assesment_configs %}
						<OPTION VALUE="{{config.id_assesment_config}}">{{config.name}}</OPTION>
					{% endfor %}
				</select>
				<form action="" method="post" id='formJson'>{% csrf_token %}
					<p class="label_input">Nombre Configuracion</p>
					<input name="input_nombre" id="input_nombre" class="ui-corner-all placeholder simple-input search-input blur-on-esc" type="text" placeholder="Nombre configuracion"/>
					<p class="label_input">Nota Minima</p>
					<input name="nota_minima" id="skill_search" class="ui-corner-all placeholder simple-input search-input blur-on-esc" type="number" min="0" placeholder="Nota minima"/>
					<p class="label_input">Nota Maxima</p>
					<input name="nota_maxima" id="skill_search" class="ui-corner-all placeholder simple-input search-input blur-on-esc" type="number" min="0" placeholder="Nota maxima"/>
					<p class="label_input">Fecha Inicio</p>
					<input name="fecha_inicio" id="skill_search" class="ui-corner-all placeholder simple-input search-input blur-on-esc" type="date" placeholder="Fecha inicio"/>
					<p class="label_input">Fecha Termino</p>
					<input name="fecha_termino" id="skill_search" class="ui-corner-all placeholder simple-input search-input blur-on-esc" type="date" placeholder="Fecha termino"/>
					<input name="input_id_config" id="input_id_config" style="display:none;" "class="" value="" >
					<input name="input_kaid" id="input_kaid" style="display:none;" "class="" value="" >
					<input name="input_id_assesment" id="input_id_assesment" style="display:none;" "class="" value="" >
					<input name="input_id_class" id="input_id_class" style="display:none;" "class="" value="" >
				</form>
			</div>
			<div class="parametros" id="parametros">Parametros</div>
			<div class="skills" id="skills" align="left">Skills</div>
			<div id="sinEvaluar" class="sinEvaluar" ondragenter="return enter(event)" ondragover="return over(event)" ondragleave="return leave(event)" ondrop="return drop(event)"></div>
		    <div class="flechas"><IMG SRC="http://1.bp.blogspot.com/_qgZA1ny_dAs/S0QKBZIBjwI/AAAAAAAADiE/ne7stP8FB60/s320/arrow3b.png" onClick="EvaluarTodos()"></div>
			<div id="Evaluados" class="Evaluados" ondragenter="return enter(event)" ondragover="return over(event)" ondragleave="return leave(event)" ondrop="return drop(event)"></div>				
			<div class="flechas"><IMG SRC="http://2.bp.blogspot.com/_qgZA1ny_dAs/S0QFh598GZI/AAAAAAAADhE/ct32e3-IK9I/s200/arrow3a.png" onClick="noEvaluarTodos()"></div>
			<div><input type="button" id="button_realizar" onClick="realizarEvaluacion()" class="kui-button kui-button-plain kui-button-primary" value="Realizar Evaluacion"></div>
			<div><input type="button" id="button_editar" name="" onClick="updateAssesment()" class="kui-button kui-button-plain kui-button-primary" value="Editar Evaluacion" style="display:none"></div>
	</div>
			
	
	<div align="center">
	
	<script type="text/javascript">
	
	var Needle = (function() {
        /** 
          * Helper function that returns the `d` value
          * for moving the needle
        **/
        var recalcPointerPos = function(perc) {
          var centerX, centerY, leftX, leftY, rightX, rightY, thetaRad, topX, topY;
          thetaRad = percToRad(perc / 2);
          centerX = 0;
          centerY = 0;
          topX = centerX - this.len * Math.cos(thetaRad);
          topY = centerY - this.len * Math.sin(thetaRad);
          leftX = centerX - this.radius * Math.cos(thetaRad - Math.PI / 2);
          leftY = centerY - this.radius * Math.sin(thetaRad - Math.PI / 2);
          rightX = centerX - this.radius * Math.cos(thetaRad + Math.PI / 2);
          rightY = centerY - this.radius * Math.sin(thetaRad + Math.PI / 2);
          return "M " + leftX + " " + leftY + " L " + topX + " " + topY + " L " + rightX + " " + rightY;
        };

        function Needle(el,id) {
          
          this.el = el;
          this.id = id;
          this.len = 24;//width / 3;
          this.radius = 4;//this.len / 6;
        }

        Needle.prototype.render = function() {
          this.el.append('circle').attr('class', 'needle-center').attr('cx', 0).attr('cy', 0).attr('r', this.radius);
          return this.el.append('path').attr('class', 'needle').attr('d', recalcPointerPos.call(this,0));
        };

        Needle.prototype.moveTo = function(perc) {
          var self,
              oldValue = this.perc || 0;

          this.perc = perc;
          self = this;
          
          var id=this.id;

          // Reset pointer position
          this.el.transition().delay(100).ease('quad').duration(200).select('.needle').tween('reset-progress', function() {
            return function(percentOfPercent) {
              var progress = (1 - percentOfPercent) * oldValue;
              repaintGauge(progress,id);
              return d3.select(this).attr('d', recalcPointerPos.call(self, progress));
            };
          });

          this.el.transition().delay(300).ease('bounce').duration(1500).select('.needle').tween('progress', function() {
            return function(percentOfPercent) {
              var progress = percentOfPercent * perc;
              repaintGauge(progress,id);
              return d3.select(this).attr('d', recalcPointerPos.call(self, progress));
            };
          });

        };

        return Needle;

      })();
	</script>
	
	<script type="text/javascript">
	
		$(document).ready(function(){
	  		noEvaluarTodos()
	  		$("#hover").click(function(){
	  	        $(this).fadeOut();
	  	    	$("#popup").fadeOut();
	  	    });
	  	  	$("#close").click(function(){
	  	        $("#hover").fadeOut();
	  	    	$("#popup").fadeOut();
	  	    });
	  		$('body').append('<div id="sortMenu"></div>');
	  		$('table#studentsDashboard').tableSort({
	  			animation: 'slide',
	  			speed: 1200
	  		});
		});

		var json = JSON.parse('{{ jason_data | escapejs }}');
		var students = json.students;
		var assesments=json.assesments;
		console.log("assesments");
		console.log(assesments);
		var data = [];
		data.push(students);
	    // column definitions
	    //d3.f is a d3-jetpack function that saves code writing by replacing a line of code -> d3.f("name") = function(d){return d.name}
	    var columns = [
	        { head: 'Estudiantes', cl: 'name', html: d3.f('name'), type:'text'},
	        { head: 'Recomendaciones completadas', cl: 'recommendations', values: d3.f('recommendations'), type:'numeric'},
	        { head: 'Ejercicios desarrollados', cl: 'exercises', values: d3.f('corrects') , type:'numeric'},
	        { head: 'Tiempo en ejercicios', cl: 'skills_time', value: d3.f('skills_time'), valueF : d3.f('skills_time',length()) , type:'numeric'},
	        { head: 'Tiempo en videos', cl: 'videos_time', valueF: d3.f('video_time', length()), value: d3.f('video_time') , type:'numeric'},
	        { head: 'Habilidades dominadas', cl: 'skills_level', value: d3.f('skills_level'), type:'numeric'}
	        //{ head: 'Evaluacion1', cl: 'assesment', id: 'tooltip', tooltip: '{% for assesment_config in assesment_configs %}{{ "Nombre: " }}{{ assesment_config.name }}{{ "<hr style=margin: 0>% aprobacion: " }}{{ assesment_config.approval_percentage }}{{ "<hr style=margin: 0>Puntaje maximo: " }}{{ assesment_config.top_score }}{% endfor %}', value: d3.f('evaluacion')}//, html: d3.f('evaluacion') },
	    ];
	    
	    for (i=0; i<json["assesments"].length; i++){
	    	var class_id="assesment"+json["assesments"][i]["id"];
	    	//console.log(class_id);
	    	columns.push({head_assesment: json["assesments"][i]["name"], number: i, cl: class_id, tooltip: "Nombre: "+json["assesments"][i]["config_name"]+"<hr style=margin: 0>% aprobacion: "+json["assesments"][i]["approval_percentage"]+"<hr style=margin: 0>Puntaje maximo: "+json["assesments"][i]["top_score"]+"<hr style=margin: 0>Nota maxima: "+json["assesments"][i]["max_grade"]+"<hr style=margin: 0>Nota minima: "+json["assesments"][i]["min_grade"], value: d3.f(class_id), type:'numeric'})//html: d3.f('evaluacion')})
	    	data.push(assesments[i]["assesment_student"]);
	    }
	    
	    var selectedAssesment=false;
	    //for (i in data){ console.log(data[i])}
		var barWidth, chart, chartInset, degToRad, repaintGauge,
		    height, margin, numSections, padRad, percToDeg, percToRad, 
		    percent, radius, sectionIndx, svg, totalPercent, width;
    
	    percent = .75;
		numSections = 1;
		sectionPerc = 1 / numSections / 2;
		padRad = 0.025;
		chartInset = 10;
		
		// Orientation of gauge:
		totalPercent = .75;
		
		el = d3.select('.chart-gauge');
		
		/*margin = {
		  top: 20,
		  right: 20,
		  bottom: 30,
		  left: 20
		};*/
		
		width = 200;//el[0][0].offsetWidth - margin.left - margin.right;
		height = 50;
		radius = Math.min(width, height) / 2;
		barWidth = 40 * width / 300;
		
		var arc1_array = new Array();
		
		//d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth);
    	var arc2_array = new Array();
    	//d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth);
		var d3_needles = new Array();
	 // create table
	    var table = d3.select('body')
	    	.append('div')
	    	.attr('class', 'contained-and-centered')
	    	.append('div')
	    	.attr('align', 'center')
	        .append('table')
	        .attr('id','studentsDashboard')
	        .style('width', '99%');
	        
	    table.append('caption').text('{% for class in classroom %}{{ class.level }} {{ class.letter }}').text(' Nueva Evaluacion{% endfor %}')

	    // create table header
	    table.append('thead').append('tr')
	        .selectAll('th')
	        .data(columns).enter()
	        .append('th')
	        .attr('class', d3.f('cl'))
	        .attr('id', d3.f('id'))
	        .attr('title', d3.f('tooltip'))
	        .attr('data-sortBy',d3.f('type'))
	        .text(d3.f('head'));
	    
	    var sortDivName=table.select('th.name').append('div').attr("class","sort-div");
    	sortDivName.append("img")
    		.attr("class","ascSort")
    		.attr("name","name")
    		.attr("column",function(d){
    			return $('th.name').index();

    		})
    		.attr("src","{% static 'tablesorter/arrow_asc.png' %}");
    		/*.on("click",function(d){
    			var th_index_selected = $('th.name').index();
    			ascendingSort(th_index_selected);
    		});*/
    	sortDivName.append("img")
    		.attr("class","descSort")
    		.attr("name","name")
    		.attr("column",function(d){
    			return $('th.name').index();

    		})
    		.attr("src","{% static 'tablesorter/arrow_desc.png' %}");
    		/*.on("click", function(d){
    			var th_index = $('th.name').index();
    			//descendingSort(th_index);
    		});*/
	    
	    var sortDivSkillsTime=table.select('th.skills_time').append('div').attr("class","sort-div");
    	sortDivSkillsTime.append("img")
    		.attr("class","ascSort")
    		.attr("name","skills_time")
    		.attr("column",function(d){
    			return $('th.skills_time').index();

    		})
    		.attr("src","{% static 'tablesorter/arrow_asc.png' %}");
    		/*.on("click",function(d){
    			var th_index_selected = $("th.skills_time").index();
    			d3.selectAll("td.skills_time").attr("data-sortAs",function(d){return d.value;})
    		});*/
    	sortDivSkillsTime.append("img")
    		.attr("class","descSort")
    		.attr("name","skills_time")
    		.attr("column",function(d){
    			return $('th.skills_time').index();
    		})
    		.attr("src","{% static 'tablesorter/arrow_desc.png' %}");
    		/*.on("click", function(d){
    			var th_index = $('th.skills_time').index();
    		});*/
    	

    	var sortDivVideosTime=table.select('th.videos_time').append('div').attr("class","sort-div");
        sortDivVideosTime.append("img")
        	.attr("class","ascSort")
        	.attr("name","videos_time")
        	.attr("column",function(d){
        		return $('th.videos_time').index();

        	})
        	.attr("src","{% static 'tablesorter/arrow_asc.png' %}");
        		/*.on("click",function(d){
        			var th_index_selected = $("th.skills_time").index();
        			d3.selectAll("td.skills_time").attr("data-sortAs",function(d){return d.value;})
        		});*/
        sortDivVideosTime.append("img")
        	.attr("class","descSort")
        	.attr("name","videos_time")
        	.attr("column",function(d){
        		return $('th.videos_time').index();
        	})
        	.attr("src","{% static 'tablesorter/arrow_desc.png' %}");
        		/*.on("click", function(d){
        			var th_index = $('th.skills_time').index();
        		});*/

   		var sortDivRec=table.select('th.recommendations').append('div').attr("class","sort-div");
        sortDivRec.append("img")
           	.attr("class","ascSort")
           	.attr("name","recommendations")
           	.attr("column",function(d){
           		return $('th.recommendations').index();

           	})
           	.attr("src","{% static 'tablesorter/arrow_asc.png' %}");
           	/*.on("click",function(d){
           		tbody.selectAll("td.recommendations").attr("data-sortAs",function(d){return d.values.completed_perc;});
           	});*/
        sortDivRec.append("img")
           	.attr("class","descSort")
           	.attr("name","recommendations")
           	.attr("column",function(d){
           		return $('th.recommendations').index();
           	})
           	.attr("src","{% static 'tablesorter/arrow_desc.png' %}");
           	/*.on("click", function(d){
           		tbody.selectAll("td.recommendations").attr("data-sortAs",function(d){return d.values.completed_perc;});
           	});*/
                		
	    //table.selectAll('.assesment').append('button').attr('onclick',function(d) { return 'changeData('+d.number+')' }).text(d3.f('head_assesment'));
	    //table.selectAll('.assesment').append('div').attr("class","sort-div").html('<button type="button">Up</button><button type="button">Down</button>');
	    for (i=0; i<json["assesments"].length; i++){
	    	var class_id="assesment"+json["assesments"][i]["id"];
	    	var number_class_id=json["assesments"][i]["id"];
	    	table.select('th.'+class_id)
	    		.append('div')
	    		.attr("id",number_class_id).html('<button type="button" onClick="editarAssesment('+number_class_id+')">editar</button>');
	    	table.select('th.'+class_id)
	    		.append('button')
	    		.attr("id",class_id)
	    		.attr("class","assesment kui-button kui-button-plain kui-button-primary")
	    		.attr('onclick',function(d) { return 'changeData('+d.number+',"'+d.cl+'")' }).text(d3.f('head_assesment'));
	    	var sort_div=table.select('th.'+class_id).append('div').attr("class","sort-div");
	    	sort_div.append("img")
	    		.attr("src","{% static 'tablesorter/arrow_asc.png' %}")
	    		.on("mouseover",function(d){
	    			var position = d3.mouse(this);
	    		    d3.select('#sortMenu')
	    		      .html("<ul><li>Nota</li><li>Esfuerzo</li></ul>")
	    		      .style('position', 'absolute')
	    		      .style('left', (this.x + position[0]) + "px")
	    		      .style('top', (this.y + position[1]) + "px")
	    		      .style('display', 'block');

	    		    d3.event.preventDefault();
	    		});
	    	sort_div.append("img")
	    		.attr("src","{% static 'tablesorter/arrow_desc.png' %}")
	    		.on("mouseover",function(d){
	    			var position = d3.mouse(this);
	    		    d3.select('#sortMenu')
	    		      .html("<ul><li>Nota</li><li>Esfuerzo</li></ul>")
	    		      .style('position', 'absolute')
	    		      .style('left', (this.x + position[0]) + "px")
	    		      .style('top', (this.y + position[1]) + "px")
	    		      .style('display', 'block');

	    		    d3.event.preventDefault();
	    		});
	    	
	    		
	    	
	    }	    
	    var dataIndex = 0;
	    var backgroundJobs = data[dataIndex];
	    
		////////////// ESCALAR TIEMPOS SKILLS Y VIDEOS //////
	    
		function Greatest(data){
	    	greaterThan=0;
	    	for (i=0; i<data.length; i++){
		    		if (data[i]>greaterThan){
		    			greaterThan = parseInt(data[i]);
		    		}
	    	}
	    	return greaterThan
	    };
		
	    var skill_time=new Array();
	    skill_time = d3.map(backgroundJobs, function(d){return d.skills_time;}); //d3.f("skills_time"));
	    console.log(skill_time);
	    var skillsTimeScaling = d3.scale.linear()
                            .domain([0,Greatest(skill_time.keys())])
                            .range([0,150]);
                            
        var videos_time = (d3.map(backgroundJobs, function(d) { return d.video_time }));
        var escalarTiemposVideo = d3.scale.linear()
                            .domain([0,Greatest(videos_time.keys())])
                            .range([0,150]);
	    
        var corrects = (d3.map(backgroundJobs, function(d) { return d3.max([d.corrects[0],d.corrects[1]]);}));
        corrects= corrects.keys().map(function(d){
        	return parseInt(d);
        })
        var escalarCorrectIncorrect = d3.scale.linear()
                            .domain([0,d3.max(corrects)])
                            .range([0,75]);
        ///////////////////////////////////////////////////
	    
	    
	    var changeData = function (dataIndex , assesment) {
        	if (!selectedAssesment){
		    	backgroundJobs = data[dataIndex+1];
		    	selectedAssesment=true;
		    	//Filters every circle that is not from the clicked assesment and show them almost transparent
		    	tbody.selectAll("circle:not(."+assesment+")")
		    		.filter(".assesment")
		    		.transition()
		    		.duration(750)
		    		.style("opacity",0.15);
		    	//Disable other assesment buttons
		    	$("button.assesment").filter(":not(#"+assesment+")").prop("disabled",true);
		    	$("button.assesment").filter(":not(#"+assesment+")").css("pointer-events","none");
		    	$("button.assesment").filter(":not(#"+assesment+")").fadeTo(750,0.1);
        	}else{
        		backgroundJobs = data[0];
        		selectedAssesment=false;
        		tbody.selectAll("circle:not(."+assesment+")")
		    		.filter(".assesment")
		    		.transition()
		    		.duration(750)
		    		.style("opacity",1);
        		//Enable back other assesment buttons
        		$("button.assesment").filter(":not(#"+assesment+")").prop("disabled",false);
        		$("button.assesment").filter(":not(#"+assesment+")").css("pointer-events","initial");
        		$("button.assesment").filter(":not(#"+assesment+")").fadeTo(750,1);
        	}
        	skill_time = d3.map(backgroundJobs, function(d){return d.skills_time;}); //d3.f("skills_time"));
		    console.log(skill_time);
		    skillsTimeScaling = d3.scale.linear()
	                            .domain([0,Greatest(skill_time.keys())])
	                            .range([0,150]);
		    videos_time = (d3.map(backgroundJobs, function(d) { return d.video_time }));
	        escalarTiemposVideo = d3.scale.linear()
	                            .domain([0,Greatest(videos_time.keys())])
	                            .range([0,150]);
	        corrects = (d3.map(backgroundJobs, function(d) { return d3.max([d.corrects[0],d.corrects[1]]);}));
	        corrects= corrects.keys().map(function(d){
	        	return parseInt(d);
	        })
	        console.log("corrects");
	        console.log(corrects);
	        escalarCorrectIncorrect = d3.scale.linear()
	                            .domain([0,d3.max(corrects)])
	                            .range([0,75]);
		    
	        tick_update();
	    }
	    

        /////////// escala de skill_levels de jordan y tu
        var skill_levels_scaling=d3.scale.linear()
		.domain([0,d3.max(students,function(d){
			console.log(d);
			var total_skills=0;
				total_skills=total_skills+d.skills_level.struggling;
				total_skills=total_skills+d.skills_level.practiced;
				total_skills=total_skills+d.skills_level.mastery1;
				total_skills=total_skills+d.skills_level.mastery2;
				total_skills=total_skills+d.skills_level.mastery3;
				return total_skills;
			})])
			.range([0,100]);
	
		//skills_level_colors = ["#9CDCEB", "#58C4DD", "#29ABCA", "#1C758A"];
		skills_level_colors = ["#C30202","#9CDCEB", "#58C4DD", "#29ABCA", "#1C758A"];
		
		
		var reprobate_colors = ["#C30202", "#FB6060"];
	    //var approve_colors = ["#9CDCEB", "#58C4DD", "#29ABCA", "#1C758A"];
	   	var approve_colors = ["#9CDCEB", "#1C758A"];
	    var reprobateColour = d3.scale.linear()
		  .domain([2, 3.9])//, 1.9 / (reprobate_colors.length - 1)))
		  .range(reprobate_colors);
  		var approveColour = d3.scale.linear()
		  .domain([4.0,7.0])//d3.range(4,7, 3.0 / (approve_colors.length - 1)))
		  .range(approve_colors);

        
		/////////////// parte principal para dibujar la tabla //////////////////////////////  
		table.append('tbody');
	    
	    var tbody = d3.select('tbody');

	    function tick() {
	    	
	        var rows = tbody.selectAll("tr")
	    	.data(backgroundJobs, function(d) {
	    	    return d.name;
	    	});

	    	rows.enter()
	    		.append("tr");
	    	//rows.transition().sort(function (a, b) { return a == null || b == null ? 0 : stringCompare(a[attrName], b[attrName]); });
	        
	        //rows.order();

	        var cells = rows.selectAll("td")
	    		.data(function(row,i) {
	    			return columns.map(function(c) {
		                // compute cell values for this specific row
		                var cell = {};
		                d3.keys(c).forEach(function(k) {
		                    cell[k] = typeof c[k] == 'function' ? c[k](row,i) : c[k];
		                });
		                return cell;
	    			});
	    		});

	    	cells.enter()
	    		.append("td").html(d3.f('html'))
		        .attr('class', d3.f('cl'))
		        .attr('id', d3.f('id'));
	    	
	    	cells.text(function(d) { return d.html;});
	    	
	    	drawRecommendations();
	    	drawSkillTime();
	    	drawVideoTime();
	    	drawCorrectIncorrect();
	    	drawSkillLevels();
	    	drawBalls();
	    	
	    	cells.exit().remove();
	    	rows.exit().remove();
	    }
	    
		function tick_update() {
	    	
	        var rows = tbody.selectAll("tr")
	    	.data(backgroundJobs, function(d) {
	    	    return d.name;
	    	});

	    	/*rows.enter()
	    		.append("tr");
	        
	        rows.order();*/

	        var cells = rows.selectAll("td")
	    		.data(function(row,i) {
	    			return columns.map(function(c) {
		                // compute cell values for this specific row
		                var cell = {};
		                d3.keys(c).forEach(function(k) {
		                    cell[k] = typeof c[k] == 'function' ? c[k](row,i) : c[k];
		                });
		                return cell;
	    			});
	    		});
	       
	       cells.select("svg");
	       svg=tbody.selectAll("svg");
	       
	       //Update data of skills time d3 elements
	       svg.select("rect.skills_time");
	       svg.select("text.skills_time");
	       
	       //Update data of videos time d3 elements
	       svg.select("rect.videos_time");
	       svg.select("text.videos_time");
	       
	       //Update data of exercises d3 elements (incorrects and corrects)
	       svg.select("rect.incorrect");
	       svg.select("text.incorrect");
	       svg.select("rect.correct");
	       svg.select("text.correct");
	       
	       //Update data of skill level d3 bars
	       //svg.select("rect.skills_level");
	       
		   //Update data of g where d3 gauge of rec completed are drawn
		   svg.select("g.recommendations");
	        
	    	drawSkillTimeUpdate();
	    	drawVideoTimeUpdate();
	    	drawCorrectIncorrectUpdate();
	    	drawSkillLevelsUpdate();
	    	drawRecommendationsUpdate();
	    	//drawBalls();
	    	
	    	//cells.exit().remove();
	    	//rows.exit().remove();
	    }
	    
	    /////////////// Functions to draw the d3 graphs on the table /////////////////////
	    
	    function drawSkillTime(){
		    var tiempos_skill = tbody.selectAll('.skills_time')
		    	.append("svg")
		    	.attr("class","skills_time")
		    	.style("width","160")
		    	.style("height","30");
		    tiempos_skill
		    	.append("rect")
		    	.attr("class","skills_time")
		    	.attr("y",12)
		    	.style("fill","#FC8A3B")
		    	.attr("width","0").transition().duration(750)
		    	.attr("width",function(d){return skillsTimeScaling(d.value)})
		    	.attr("height","20")
		    	.style("fill","#FC8A3B");
		    
		    tiempos_skill
		    	.append("text")
		    	.attr("class","skills_time")
			    .attr("x", 0)//function(d) { return skillsTimeScaling(d.value)+2 })
			    .attr("y", 5)
			    .attr("dy", ".35em")
				.attr("fill", "black")
			    .text(function(d) { return d.valueF });
	    }
	    
	    function drawSkillTimeUpdate(){
		    var skills_time_bars = tbody.selectAll('.skills_time rect')
		    	.transition().duration(750)
		    	.attr("width",function(d){return skillsTimeScaling(d.value)});
		    skills_time_texts = tbody.selectAll('.skills_time text')
		    	.transition().duration(750)
			    //.attr("x", function(d) { return skillsTimeScaling(d.value)+2 })
			    .text(function(d) { return d.valueF });
		    }
	    
	    function drawVideoTime(){
		    var tiempos_video = tbody.selectAll(".videos_time")
		    	.append("svg")
		    	.attr("class","videos_time")
		    	.style("width","160")
		    	.style("height","30")
		    tiempos_video
		    	.append("rect")
		    	.attr("class","videos_time")
		    	.attr("y",12)
		    	.style("fill","#FC8A3B")
		    	.attr("height","20")
		    	.attr("width","0").transition().duration(750)
		    	.attr("width",function(d){return escalarTiemposVideo(d.value)});
		    
		    tiempos_video
		    	.append("text")
		    	.attr("class","videos_time")
			    .attr("x", 0 )//function(d) { return escalarTiemposVideo(d.value)+5; })
			    .attr("y", 5)
			    .attr("dy", ".35em")
				.attr("fill", "black")
			    .text(function(d) { return d.valueF });
	    }
	    
	    function drawVideoTimeUpdate(){
	    	var video_times_bars = tbody.selectAll('.videos_time rect')
				.transition().duration(750)
	    		.attr("width",function(d){return escalarTiemposVideo(d.value)});
	    	var video_times_texts = tbody.selectAll('.videos_time text')
	    		.transition().duration(750)
	    		//.attr("x", function(d) { return escalarTiemposVideo(d.value)+5; })
	    		.text(function(d) { return d.valueF });

		}
	    
	    function drawCorrectIncorrect(){
		    var correct_incorrect = tbody.selectAll(".exercises")
		    	.append("svg")
		    	.attr("class","exercises")
		    	.style("width","160")
		    	.style("height","30");
		    
		    var incorrectos = correct_incorrect.append("rect")
		    	  .attr("class","incorrect")
		    	  .attr("height","20")
		    	  .attr("x",80)
		    	  .attr("y",12)
		    	  .transition().duration(750)
		    	  .attr("x", function(d) { return 80-escalarCorrectIncorrect(d.values[1]); })
			      .attr("width", function(d){return escalarCorrectIncorrect(d.values[1]); })
		    	  .style("fill","red");
	
		    correct_incorrect
		    	.append("text")
		    	.attr("class","incorrect")
			    .attr("x", function(d){
			    	//var textWidth=d3.selection(this).getBBox();
			    	//console.log(d3.selection(this).node().getBoundingClientRect().width);
			    	return 80;
			    ;})//function(d) { return  80-escalarCorrectIncorrect(d.values[1]);})
			    .attr("y", 5)
			    .attr("dy", ".35em")
				.attr("fill", "black")
			    .text(function(d) { return d.values[1] });
			correct_incorrect.selectAll("text")
				.attr("transform",function(d){
					var textWidth = d3.select(this).node().getBBox().width;
					return "translate("+(-(d3.select(this).node().getBBox().width+3))+",0)";
					});
		    var correctos = 
		    	correct_incorrect.append("rect")
		    	.attr("class","correct")
		    	.attr("x",80)
		    	.attr("y",12)
		    	.style("fill","green")
		    	.attr("width","0").transition().duration(750)
		    	.attr("width",function(d){return escalarCorrectIncorrect(d.values[0])})
		    	.attr("height","20")
		    	.style("fill","#9DB63B");
		    
		    correct_incorrect
		    	.append("text")
		    	.attr("class","correct")
			    .attr("x", 83)//function(d) { return 93+escalarCorrectIncorrect(d.values[0])})
			    .attr("y", 5)
			    .attr("dy", ".35em")
				.attr("fill", "black")
			    .text(function(d) { return d.values[0] });
	    }
	    
	    function drawCorrectIncorrectUpdate(){
		    var incorrect_bars = tbody.selectAll("rect.incorrect")
		    	  .transition().duration(750)
		    	  .attr("x", function(d) { return 80-escalarCorrectIncorrect(d.values[1]); })
			      .attr("width", function(d){return escalarCorrectIncorrect(d.values[1]); });

		    var incorrect_texts = tbody.selectAll("text.incorrect")//correct_incorrect
		    	.text(function(d) { return d.values[1] })
			    .transition().duration(750)
		    	.attr("transform",function(d){
					var textWidth = d3.select(this).node().getBBox().width;
					return "translate("+(-(d3.select(this).node().getBBox().width+3))+",0)";
				});
		    
		    var correct_bars = tbody.selectAll("rect.correct")
		    	.transition().duration(750)
		    	.attr("width",function(d){return escalarCorrectIncorrect(d.values[0])})
		    var correct_texts = tbody.selectAll("text.correct")
		    	.transition().duration(750)
			    //.attr("x", function(d) { return 80+escalarCorrectIncorrect(d.values[0])})
			    .text(function(d) { return d.values[0] });
		    }
	    
	    function drawSkillLevels() {
		    var skill_levels = tbody.selectAll(".skills_level")
	    	.append("svg")
	    	.attr("class","skills_level")
	    	.style("width","150px")
	    	.style("height","20px")
			skill_levels.selectAll('rect')
			      .data(function(d,i){
			    	  var skills_array=[];
			    	  skills_array[0]=d.value.struggling;
			    	  skills_array[1]=d.value.practiced;
			    	  skills_array[2]=d.value.mastery1;
			    	  skills_array[3]=d.value.mastery2;
			    	  skills_array[4]=d.value.mastery3;
			    	  var skills=[]
			    	  for (var j=0;j<skills_array.length;j++){
			    		  var offset=0;
			    		  for (var k=j-1;k>=0;k--){
			    			  offset=offset+skills_array[k];
			    		  }
			    		  skills.push({id_level:j, value: skills_array[j], prev_value: offset});
			    	  }
			    	  console.log(skills);
			    	  return skills;
			      })
			      .enter()
			      .append('rect')
			      .attr("class","skills_level")
			      .attr('width', function(d){
			          return d.value;})
			      .attr('x',function(d, i){
			          return d.prev_value;})
			      .attr('y',0)
			      .attr('height', "20px")
			      .style('fill', function(d, i){ return skills_level_colors[i]; });
		}
		
		function drawSkillLevelsUpdate() {
		    var skill_levels = tbody.selectAll("rect.skills_level")
		    	.each(function(d,i){
		    		var new_data=this.parentNode.__data__;
		    		var id_level = d.id_level;
		    		var skills_array=[];
			    	skills_array[0]=new_data.value.struggling;
			    	skills_array[1]=new_data.value.practiced;
			    	skills_array[2]=new_data.value.mastery1;
			    	skills_array[3]=new_data.value.mastery2;
			    	skills_array[4]=new_data.value.mastery3;
			    	var skills=[];
			    	var offset=0;
			    	for (var j=id_level-1;j>=0;j--){
			    		offset=offset+skills_array[j];
			        }
			    	d.value = skills_array[id_level];
			    	d.prev_value = offset;
		    	});
		    tbody.selectAll("rect.skills_level")
			      .transition().duration(750)
			      .attr('width', function(d){
			          return d.value;})
			      .attr('x',function(d, i){
			          return d.prev_value;});
			}
		
		function drawBalls(){
		var effort_scalings = [];
	    for (i=0; i<json["assesments"].length; i++){
	    	assesment_id="assesment"+json["assesments"][i]["id"]
	    	effort_scalings[assesment_id] = d3.scale.log()
	    									.domain([d3.min(students,function(d){return d[assesment_id].effort;}),//d3.filter(students,function(d){return d[assesment_id].effort;})),
	    										d3.max(students,function(d){return d[assesment_id].effort;})])//d3.filter(students,function(d){return d[assesment_id].effort;}))])
	    									.range([11,22]);
	    	console.log(effort_scalings[assesment_id](0.32));												
	    	var assesments = tbody.selectAll("td.assesment"+json["assesments"][i]["id"]).attr("class","assesment assesment"+json["assesments"][i]["id"])
		    	.append("svg")
		    	.style("width","100%")
	    		.style("height",height);
		    	//.style("width", "44")//function(d){return escalarTiemposVideo(d.value) })
		    	//.style("height","44")
			
	    	assesments.append("circle")
	    		.attr("class","assesment assesment"+json["assesments"][i]["id"])
	    		.attr("cx", function (d) { return 22.5; })
	            .attr("cy", function (d) { return 22.5; })
	    		.attr("r",function(d,i){
	    			return effort_scalings[d.cl](students[i][assesment_id].effort);
	    		})
	    		.style("fill",
	    				function(d,i){ 
	    					if (students[i][assesment_id].grade<4.0){
	    						return reprobateColour(students[i][assesment_id].grade);
	    					}else{
	    						return approveColour(students[i][assesment_id].grade);
	    					}
	    			  });
		    	
	    	assesments.append("text")
	    		.attr("class","assesment assesment"+json["assesments"][i]["id"])
		        .attr("dx", function(d,i){return effort_scalings[d.cl](students[i][assesment_id].effort);})
		        .attr("dy", function(d,i){return effort_scalings[d.cl](students[i][assesment_id].effort) + 10;})
		        .text(function(d,i){return students[i][assesment_id].grade})
		        .style("fill","white");
		    	
		    $("circle."+assesment_id).tipsy({ 
		        gravity: 'n',
		        opacity: 0.9,
		        html: true, 
		        title: function() {
		          var d = this.__data__;
		          d = d.value;
		          return '<ul><li>Nota '+d.grade+'</li><li>Esfuerzo '+d.effort+'</li></ul>' ; 
		        }
		      });
		    /*$("text."+assesment_id).tipsy({ 
		        gravity: 'n',
		        opacity: 0.9,
		        html: true, 
		        title: function() {
		          var d = this.__data__;
		          d = d.value;
		          return '<ul><li>Nota '+d.grade+'</li><li>Esfuerzo '+d.effort+'</li></ul>' ; 
		        }
		      });*/
		        
	    }
		}
		
		function percToDeg(perc) {
		    return perc * 360;
		};

		function percToRad(perc) {
		    return degToRad(percToDeg(perc));
		};

		function degToRad(deg) {
		    return deg * Math.PI / 180;
		};

		
		/////////////// dibujar al principio ///////////////////
	    tick();
	    
		
		//Funciones para dibujar el recommendations gauge //
	    function length() {
	        var fmt = d3.format('02d');
	        return function(l) { return Math.floor(l / 60) + ':' + fmt(l % 60) + ''; };
	    }
		
	    function drawRecommendations(){
	    	tbody.selectAll("td.recommendations").attr("data-sortAs",function(d){return d.values.completed_perc;});
	    	var recommendations = tbody.selectAll('.recommendations')
	    							.append("svg")
	    							.attr("class","recommendations")
	    							.style("width","100%")
	    							.style("height",height);
	    	var g_rec = recommendations.append('g').attr("class","recommendations")
	    		.attr('transform', "translate(" + width/3 + ", " + (height) + ")");
	    	/*g_rec.each(function(d,i){
	    		arc1_array[i]=d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth);
	    		arc2_array[i]=d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth);
	    	})*/
	    	g_rec.append('svg:path').attr('class', "arc chart-filled").attr("id",function(d,i){return "chart-filled"+i;});/*.attr('d', function(d){
		    	var next_start = totalPercent;
		    	var perc = 40;
		    	arcStartRad = percToRad(next_start);
		    	arcEndRad = arcStartRad + percToRad(perc / 2);
		    	next_start += perc / 2;

		  	    var arc1 = d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth);
		  	    arc1.startAngle(arcStartRad).endAngle(arcEndRad);
		  	    console.log(arc1);
	    		return arc1;});*/
	    	g_rec.append('svg:path').attr('class', "arc chart-empty").attr("id",function(d,i){return "chart-empty"+i;});/*.attr('d', function(d){
	    		
	    	});*/
	    	//g_rec.append
	    	
	    	
	    	//var gRecNeedleCenter = tbody.selectAll("g.recommendations").append('circle').attr('class', 'needle-center').attr('cx', 0).attr('cy', 0).attr('r', 5);
	    	//var gRecNeedle =tbody.selectAll("g.recommendations").append('path').attr('class', 'needle').attr('d', recalcPointerPos(50,5,34));
	    	
	    	//var g_rec_array = g_rec
	    	g_rec.each(function(d,i){
	    		//console.log("i: "+i+" reco:"+d.values.completed_perc);
	    		var completed_perc = d.values.completed_perc;
	    		var next_start = totalPercent;
			    arcStartRad = percToRad(next_start);
			    arcEndRad = arcStartRad + percToRad(completed_perc / 2);
			    next_start += completed_perc / 2;
	    			//arc1_array.push(d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth)
	    			arc1_array.push(d3.svg.arc().outerRadius(40).innerRadius(25)
	    				.startAngle(arcStartRad)
	    				.endAngle(arcEndRad));
	    			arcStartRad = percToRad(next_start);
	  		      	arcEndRad = arcStartRad + percToRad((1 - completed_perc) / 2);
	    			arc2_array.push(d3.svg.arc().outerRadius(40).innerRadius(25)//radius - chartInset).innerRadius(radius - chartInset - barWidth)
	    					.startAngle(arcStartRad + padRad)
	    					.endAngle(arcEndRad));
	    			d3.select("#chart-filled"+i).transition().delay(300).ease('bounce').duration(1500).attr("d",arc1_array[i]);
	    			d3.select("#chart-empty"+i).transition().delay(300).ease('bounce').duration(1500).attr("d",arc2_array[i]);
	    			var d3_needle = new Needle(d3.select(this),i);
	    			d3_needle.render();
	    			d3_needle.moveTo(completed_perc);
		    		d3_needles.push(d3_needle);
	    		});
	
	 		
	    }
		
	    function drawRecommendationsUpdate2(){
	    	var g_rec = tbody.selectAll('g.recommendations');
	    	g_rec.each(function(d,i){
	    		var completed_perc = d.values.completed_perc;
	    		var next_start = totalPercent;
			    arcStartRad = percToRad(next_start);
			    arcEndRad = arcStartRad + percToRad(completed_perc / 2);
			    next_start += completed_perc / 2;
	    			arc1_array[i]
	    				.startAngle(arcStartRad)
	    				.endAngle(arcEndRad);
	    			arcStartRad = percToRad(next_start);
	  		      	arcEndRad = arcStartRad + percToRad((1 - completed_perc) / 2);
	    			arc2_array[i]
	    					.startAngle(arcStartRad + padRad)
	    					.endAngle(arcEndRad);
	    			d3.select("#chart-filled"+i).transition().delay(300).ease('bounce').duration(1500).attr("d",arc1_array[i]);
	    			d3.select("#chart-empty"+i).transition().delay(300).ease('bounce').duration(1500).attr("d",arc2_array[i]);
	    			d3_needles[i].moveTo(completed_perc);
	    		});
	
	 		
	    }
	    
	    function drawRecommendationsUpdate(){
	    	var g_rec = tbody.selectAll('g.recommendations');
	    	g_rec.each(function(d,i){
	    		var completed_perc = d.values.completed_perc;
	    			d3_needles[i].moveTo(completed_perc);
	    		});
	
	    	tbody.selectAll("td.recommendations").attr("data-sortAs",function(d){return d.values.completed_perc;});
	    }
	    
	    
	    
	    
	    
	    function recalcPointerPos(len,radius,perc) {
	          var centerX, centerY, leftX, leftY, rightX, rightY, thetaRad, topX, topY;
	          thetaRad = percToRad(perc / 2);
	          centerX = 0;
	          centerY = 0;
	          topX = centerX - len * Math.cos(thetaRad);
	          topY = centerY - len * Math.sin(thetaRad);
	          leftX = centerX - radius * Math.cos(thetaRad - Math.PI / 2);
	          leftY = centerY - radius * Math.sin(thetaRad - Math.PI / 2);
	          rightX = centerX - radius * Math.cos(thetaRad + Math.PI / 2);
	          rightY = centerY - radius * Math.sin(thetaRad + Math.PI / 2);
	          return "M " + leftX + " " + leftY + " L " + topX + " " + topY + " L " + rightX + " " + rightY;
	    };
	    
	    var repaintGauge = function(perc,i) 
	    {
	    	var completed_perc = perc
    		var next_start = totalPercent;
		    arcStartRad = percToRad(next_start);
		    arcEndRad = arcStartRad + percToRad(completed_perc / 2);
		    next_start += completed_perc / 2;
    			//arc1_array.push(d3.svg.arc().outerRadius(radius - chartInset).innerRadius(radius - chartInset - barWidth)
    			arc1_array[i]
    				.startAngle(arcStartRad)
    				.endAngle(arcEndRad);
    			arcStartRad = percToRad(next_start);
  		      	arcEndRad = arcStartRad + percToRad((1 - completed_perc) / 2);
    			arc2_array[i]//.push(d3.svg.arc().outerRadius(50).innerRadius(30)//radius - chartInset).innerRadius(radius - chartInset - barWidth)
    					.startAngle(arcStartRad + padRad)
    					.endAngle(arcEndRad);
    			d3.select("#chart-filled"+i).attr("d",arc1_array[i]);
    			d3.select("#chart-empty"+i).attr("d",arc2_array[i]);
	    }		
		
		function noEvaluarTodos(){
			{% if students %}
				$("#sinEvaluar").empty();
				$("#Evaluados").empty();
				{% for student in students %}
					$("#sinEvaluar").append("<div title='{{ student.name }}' class='cuadradito' id='{{ student.kaid_student }}' draggable='true' ondragstart='start(event)' ondragend='end(event)'>{{ student.name }}</div>");
				{% endfor %}
			{% endif %}
		}
		
		function EvaluarTodos(){
			{% if students %}
				$("#sinEvaluar").empty();
				$("#Evaluados").empty();
				{% for student in students %}	
					$("#Evaluados").append("<div title='{{ student.name }}' class='cuadradito' id='{{ student.kaid_student }}' draggable='true' ondragstart='start(event)' ondragend='end(event)'>{{ student.name }}</div>");
				{% endfor %}
			{% endif %}
		}
	    
	    function start(e) {
            e.dataTransfer.effecAllowed = 'move'; // Define el efecto como mover (Es el por defecto)
            e.dataTransfer.setData("Data", e.target.id); // Coje el elemento que se va a mover
            e.dataTransfer.setDragImage(e.target, 0, 0); // Define la imagen que se vera al ser arrastrado el elemento y por donde se coje el elemento que se va a mover (el raton aparece en la esquina sup_izq con 0,0)
            e.target.style.opacity = '0.4'; 
        };

        function end(e){
            e.target.style.opacity = ''; // Pone la opacidad del elemento a 1           
            e.dataTransfer.clearData("Data");
        };

        function enter(e) {
            e.target.style.border = '3px dotted #555'; 
        };

        function leave(e) {
            e.target.style.border = ''; 
        };

        function over(e) {
            var elemArrastrable = e.dataTransfer.getData("Data"); // Elemento arrastrado
            var id = e.target.id; // Elemento sobre el que se arrastra
            
            // return false para que se pueda soltar
            if (id == 'sinEvaluar'){
                return false; // Cualquier elemento se puede soltar sobre el div destino 1
            }

            if (id == 'Evaluados'){
                return false; // En el Evaluados se puede soltar cualquier elemento menos el elemento con id=arrastrable3
            }   
        };

        function drop(e){

            var elementoArrastrado = e.dataTransfer.getData("Data"); // Elemento arrastrado
            e.target.appendChild(document.getElementById(elementoArrastrado));
            e.target.style.border = '';  // Quita el borde
            tamContX = $('#'+e.target.id).width();
            tamContY = $('#'+e.target.id).height();

            tamElemX = $('#'+elementoArrastrado).width();
            tamElemY = $('#'+elementoArrastrado).height();
    
            posXCont = $('#'+e.target.id).position().left;
            posYCont = $('#'+e.target.id).position().top;

        }
        function muestra_oculta(id){
			if (document.getElementById){ //se obtiene el id
				var el = document.getElementById(id); //se define la variable "el" igual a nuestro div
				el.style.display = (el.style.display == 'none') ? 'block' : 'none'; //damos un atributo display:none que oculta el div
		}
	}
	
	function fillParameters(id) {
		$("#parametros").empty();
		$("#parametros").append("<div>Parametros:</div>");
		{% for config in assesment_configs %}
			if ({{config.id_assesment_config}}== id){
				$("#parametros").append("<div>Porcentaje de aprovacion: {{ config.approval_percentage }}</div>");
				$("#parametros").append("<div>Importancia de Skill: {{ config.importance_skill_level }}</div>");	
				$("#parametros").append("<div>Importancia de Recomendaciones: {{ config.importance_completed_rec }}</div>");
				document.getElementById("input_id_config").value = "{{config.id_assesment_config}}";
			}
		{% endfor %}
		fillSkills(id);
		{% for class in classroom %}
			document.getElementById("input_id_class").value = "{{class.id_class}}";
		{% endfor %}
	};
	
	function fillSkills(id_config){
		$.ajax({
			url: "{% url 'evaluations:getSkillAssesment' 1 %}",
			type: "POST",
			data: {id_asses_config: id_config},
			success: function (response) {
				skills = JSON.parse(response);
				$("#skills").empty();
				$("#skills").append("<div>Skills:</div>");
				for(var i=0;i<skills.length;i++){
					$("#skills").append("<div>"+skills[i]['fields']['name_spanish']+"</div>");					
				}
			}
		});
	}
	
	function realizarEvaluacion(){
		alert("realizando evaluacion");
		var openDiv = document.getElementById('Evaluados'); 
		var cuadritos = openDiv.getElementsByClassName('cuadradito')
		var kaids =[];
		if (cuadritos.length>0){
			for (var i = 0; i < cuadritos.length; i++) {
				kaids.push({
					kaid_student:cuadritos[i].id
				});
			}
			$("input[name='input_kaid']").val(JSON.stringify(kaids))
			$.ajax({
				url: "{% url 'evaluations:newAssesment3' %}",
				type: "POST",
				data: $("#formJson").serialize(),
				success: function(response){
					$(".vaciar").empty();
					location.reload();
				}
			});
		
		}else{
			alert("no hay gente a evaluar");
		}
	}
	function modificarNota(){
		alert('modificar nota');
		var comentario = $('#textarea_coment').val()
		$("input[name='input_comment']").val(comentario)
		alert("entrando al ajax")
		$.ajax({
			url: "{% url 'evaluations:updateGrade' %}",
			type: "POST",
			data: $("#formGrade").serialize(),
			success: function(response){
				alert('guardada las notas');
				location.reload();
			}
		});		
		$('#hover').fadeOut();
		$('#popup').fadeOut();
	}
	function nuevaEvaluacion(){
		muestra_oculta('contenido_a_mostrar')
		$('#button_realizar').show()
		$('#button_editar').hide()
		$('#comboBox').prop('disabled', false);
		$("#comboBox option[value=0]").prop('selected', 'selected').change();
		$("input[name='input_nombre']").val("");
		$("input[name='fecha_inicio']").val("");
		$("input[name='fecha_termino']").val("");
		$("input[name='nota_maxima']").val("");
		$("input[name='nota_minima']").val("");
		noEvaluarTodos();
	}
	function editarAssesment(id_assesment){
		$('#contenido_a_mostrar').show();		
		$.ajax({
			url: "{% url 'evaluations:getAssesment' %}",
			async:false,
			type: "POST",
			data: {assesment:id_assesment},
			success: function(response){
				json_assesment=JSON.parse(response);
				$("input[name='input_nombre']").val(json_assesment[0]['fields']['name']);
				$("input[name='fecha_inicio']").val(json_assesment[0]['fields']['start_date']);
				$("input[name='fecha_termino']").val(json_assesment[0]['fields']['end_date']);
				$("input[name='nota_maxima']").val(json_assesment[0]['fields']['max_grade']);
				$("input[name='nota_minima']").val(json_assesment[0]['fields']['min_grade']);
				$("#comboBox option[value="+json_assesment[0]['fields']['id_assesment_conf']+"]").prop('selected', 'selected').change();
				$('#comboBox').prop('disabled', true);
			}
		});
		M_student = [];
		$.ajax({
			url: "{% url 'evaluations:getStudentAssesment' %}",
			async:false,
			type: "POST",
			data: {assesment:id_assesment},
			success: function(response){
				json_student=JSON.parse(response);
				for (i=0;i<json_student.length;i++){
					M_student.push(json_student[i]['fields']['kaid_student']);
				}
			}
		});
		{% if students %}
			$("#sinEvaluar").empty();
			$("#Evaluados").empty();
			{% for student in students %}
			if(M_student.indexOf("{{student.kaid_student}}") != -1){
				$("#Evaluados").append("<div title='{{ student.name }}' class='cuadradito' id='{{ student.kaid_student }}' draggable='true' ondragstart='start(event)' ondragend='end(event)'>{{ student.name }}</div>");
			}else{
				$("#sinEvaluar").append("<div title='{{ student.name }}' class='cuadradito' id='{{ student.kaid_student }}' draggable='true' ondragstart='start(event)' ondragend='end(event)'>{{ student.name }}</div>");
			}
			{% endfor %}
		{% endif %}
		$("input[name='input_id_assesment']").val(id_assesment)
		$('#button_realizar').hide()
		$('#button_editar').show()
	}
	function updateAssesment(){
		id_assesment = $("input[name='input_id_assesment']").val();
		alert('metodo updateAssesment: '+id_assesment);
		
		alert("realizando evaluacion");
		var openDiv = document.getElementById('Evaluados'); 
		var cuadritos = openDiv.getElementsByClassName('cuadradito')
		var kaids =[];
		if (cuadritos.length>0){
			for (var i = 0; i < cuadritos.length; i++) {
				kaids.push({
					kaid_student:cuadritos[i].id
				});
			}
			$("input[name='input_kaid']").val(JSON.stringify(kaids))
			$.ajax({
				url: "{% url 'evaluations:updateAssesment' %}",
				type: "POST",
				data: $("#formJson").serialize(),
				success: function(response){
					$(".vaciar").empty();
					location.reload();
				}
			});

		}else{
			alert("no hay gente a evaluar");
		}

	}
	    </script>

{% endblock %}