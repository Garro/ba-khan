{% extends 'home.html' %}

{% load static %}

{% block title %}Planificación Curriculum{% endblock %}

{% block body2 %}

<link rel="stylesheet" type="text/css" href="{% static 'css/planning.css'%}">

<style>
    input{
        z-index: 1000;
        width: 100%;
        height: 100%;
        margin-bottom: 10px;
    }

    label{
        margin-right: 10px;
        width: 95px;
    }

    #popup{
        padding: 20px 10px;
        height: 320px;
    }

    .popup-container{
        margin: 10px 40px;
        text-align: justify;
    }

    #popuptree{
        height:650px;
    }

    #flex-div{
        display: flex;
        flex-direction: column;
    }

    #newChapter{
    border: 1px solid #C6D1AD;
      border-radius: 5px;
      display:none; 
      height:220px; 
      padding:15px;
      padding-left: 33%;
      padding-right: 33%;
      text-align: center;
    }
    #newTopic{
    /*border: 1px solid #C6D1AD;
      border-radius: 5px;
      display:none; */
      height:220px; 
      padding:15px;
      padding-left: 33%;
      padding-right: 33%;
      text-align: center;
    }
    #newSubtopic{
    /*border: 1px solid #C6D1AD;
      border-radius: 5px;
      display:none; */
      height:220px; 
      padding:15px;
      padding-left: 33%;
      padding-right: 33%;
      text-align: center;
    }

    #summary-container{
        display: none;
        width: 1150px;
        min-height: 500px;
        margin-left: -3px;
        text-align: left;
    }

    #summary-content{
        padding-left: 20px;
        padding-bottom: 20px;
        padding-top: 20px;
        margin-right: 20px;
        height: auto;
        margin-bottom: 20px;
    }

    #topbar {
        float:left;
        position: relative;
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        z-index: 2;
        height: 50px;
        /*margin-right: -1px;*/
    }

    #topbar ul.tab {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    #topbar ul.tab li {
      margin: 0;
    }

    #topbar ul.tab li a {
        padding: 15px 20px;
        font-size: 14px;
        font-weight: 100;
        background: #EEEEEE;
        text-decoration: none;
        display: block;
        border: 1px solid #ddd;
        -webkit-transition:  background 0.3s ease-in-out;
        -moz-transition:  background 0.3s ease-in-out;
        -ms-transition:  background 0.3s ease-in-out;
        -o-transition:  background 0.3s ease-in-out;
        transition:  background 0.3s ease-in-out;
    }
    #topbar ul.tab li a.tab_select{
        border-bottom: 1px solid #f7f7f7;
        background: #f7f7f7;
        color: #56861f;
        pointer-events: none;
    }

    #topbar ul.tab li a.pie_select{
        border-bottom: 1px solid #f7f7f7;
        background: #f7f7f7;
        color: #56861f;
        pointer-events: none;
    }

    #topbar ul.tab li:hover a {
        background: #f7f7f7;
        color: #56861f;
    }
    #topbar ul.tab li:visited a {
        background: #f7f7f7;
        color: #56861f;
    }

    #topbar ul.tab li {
        float: left;
    }

    .topictree{
        overflow: hidden;
        overflow-y:scroll;
        height: 500px;
        width: 570px;
        font-size: 12px;
        padding: 5px 10px 10px 0px;
        text-align: left;
        margin: 10px;
        border: 1px solid #ddd;
    }

    .videos,.skills, .descripcion{
        border: 1px solid #D9D9D9;
        border-radius: 5px;
        width: 800px;
        height: 100px;
        max-height: 400px;
        text-align: left;
        padding: 10px;
        margin: 10px;
        margin-left: 150px;
        overflow: hidden;
        overflow: scroll;
        overflow: auto;
        background: #F6F7F7;
        float:left;
        cursor: default;
        -moz-user-select':-moz-none;
        -moz-user-select:none;
        -o-user-select:none;
        -khtml-user-select:none; 
        -webkit-user-select:none;
        -ms-user-select:none;
        user-select:none;
    }

    .bloque-info{
        border: 1px solid #D9D9D9;
        border-radius: 5px;
        width: 84%;
        height: 100px;
        max-height: 400px;
        text-align: left;
        padding: 10px;
        margin: 10px;
        margin-left: 0px;
        overflow: hidden;
        overflow: scroll;
        overflow: auto;
        background: #F6F7F7;
        float:left;
        cursor: default;
        -moz-user-select':-moz-none;
          -moz-user-select:none;
          -o-user-select:none;
          -khtml-user-select:none; 
          -webkit-user-select:none;
          -ms-user-select:none;
          user-select:none;   
    }

    .flex-div{
        display: flex;
        flex-direction: column;
    }
    .class-block{
        float: left;
        width: 320px;
        margin-left: 20px;
        margin-right: 20px;
    }

    .class-wide-block{
        float: left;
        width: 760px;
        height: auto;
        margin: 20px;
    }

    .class-wide-block table{
        width: 100%;
    }

    .class-row{
        margin-top: 6px;
        margin-bottom: 6px;
        min-height: 32px;
    }

    .class-window{
        border: 1px solid #D9D9D9;
        border-radius: 5px;
        width: 800px;
        min-height: 600px;
        text-align: left;
        padding: 20px;
        margin: 10px;
        margin-left: 0px;
        background: #F6F7F7;
        float:left;
        cursor: default;
        -moz-user-select':-moz-none;
        -moz-user-select:none;
        -o-user-select:none;
        -khtml-user-select:none; 
        -webkit-user-select:none;
        -ms-user-select:none;
        user-select:none;
    }
    .desc_label{
        margin-left: 0px;
        float: left;
        width: 300px;
        text-align: left;
    }

    .main-content{
        min-height: 1000px;
        margin-right: 20px;
        padding-left: 20px;
        padding-top: 20px;
        padding-bottom: 20px;
        width: 100%;
        float: left;
        min-width: 700px
    }

    .sum-content{
        width: 100%;
        margin-right: 20px;
        margin-left: 3px;
        margin-bottom: 20px;
        padding: 24px;
        float: left;
        min-width: 700px;
        background-color: rgb(247, 247, 247);
        border: 1px solid rgb(221, 221, 221);

    }

    .main-content li{
        text-align:left;
    }

    .main-content h2, h3{
        text-align: center;
    }

    .main-content li{
        text-align:left;
    }

    .main-content h2, h3{
        text-align: center;
    }

    .log-table{
        overflow-y: auto;
        max-height: 500px;
    }

    td.mousepointer{
        cursor: pointer;
    }

    .class-list{
        margin-top: 10px;
        max-height: 700px;
        margin-bottom: 10px;
        overflow: hidden;
    }

    .class-list:hover{
        margin-top: 10px;
        max-height: 700px;
        margin-bottom: 10px;
        overflow: auto;
    }

    .box{
        float: left;
        width: 9px;
        height: 9px;
        margin: 5px;
        margin-right: 8px;
        outline: #444444 solid 1px;
    }

    .late{
        background: #FF5656;
    }

    .not-done{
        background: #FFDF42;
    }

    .done{
        background: #0094FF;
    }

    .chart rect:first-of-type {
        color: #fff;
        stroke: #3994b6;
        fill: white;
    }

    .chart text:first-of-type {
        fill: white;
        font-family: sans-serif;
        font-size: 12px;
    }

    .chart rect:nth-of-type(2) {
        color: #fff;
        stroke: transparent;
        fill: #1C758A;
    }

    .chart text:nth-of-type(2) {
        fill: white;
        font-family: sans-serif;
        font-size: 12px;
    }

    .chart path {
        stroke: #fff;
    }

    path:hover{ 
        opacity: 0.8;
    }

    rect:hover {
        opacity: 0.8;
    }

    circle:hover {
        opacity: 0.8;
    }

    .legend tr{
        border-bottom:1px solid gray;
    }

    .legend tr:first-child{    border-top:1px solid gray; }

    .axis path, .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    .x.axis path {
        display: none;
    }

    .legend{
        margin-bottom:76px;
        display:inline-block;
        border-collapse: collapse;
        border-spacing: 0px;
    }
    .legend td{
        padding:4px 5px;
        vertical-align:bottom;
    }
    .legendFreq, .legendPerc{
        align:right;
        width:50px;
    }
    .piechart{
        height: 280px;
        margin: 10px 30px;
    }
    .piechart h3{
        width: 100px;
        margin-left: 300px;
    }
    .d3-tip {
    line-height: 1;
        font-weight: bold;
        padding: 12px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        border-radius: 2px;
    }

    /* Creates a small triangle extender for the tooltip */
    .d3-tip:after {
        box-sizing: border-box;
        display: inline;
        font-size: 10px;
        width: 100%;
        line-height: 1;
        color: rgba(0, 0, 0, 0.8);
        content: "\25BC";
        position: absolute;
        text-align: center;
    }

    /* Style northward tooltips differently */
    .d3-tip.n:after {
        margin: -1px 0 0 0;
        top: 100%;
        left: 0;
    }

    .table-cell{
        text-align: left;
        max-height: 300px;
        overflow-y: scroll;
    }
</style>

<div style="float: left">
    Autor de la planificación: {{ autor.0.name }}
</div>

<div style="float: right">
    Currículo asignado: {{ nivel_curriculo }} {{ anno_curriculo }}
</div>
<br>
<div class="copy-button">
    <a href='#' onclick='javascript:copyWarning(); return false;' class='kui-button kui-button-plain kui-button-primary'>Copiar Plan</a>
</div>

<div id="topbar" style="min-width: 1200px; height: 52px; margin-bottom: -2px; margin-top: 15px">
    <ul class="tab">
        {% for top in lista_topicos %}
            <li><a id='tab_unidad_{{ top.id_topic_mineduc }}' style="cursor: pointer; min-height 55px" href='#' onclick="cambiarUnidad({{ top.id_topic_mineduc }}); return false;">
                Unidad {{ top.index }}
            </a></li>
            {% if forloop.first %}
                <script>
                    $(document).ready(function(){
                        cambiarUnidad({{ top.id_topic_mineduc }});
                    });
                </script>
            {% endif %}
        {% endfor %}
        <li><a id='tab_resumen' style="cursor: pointer; min-height 55px" href='#' onclick="mostrarResumen(); return false;">
            Resumen
        </a></li>
    </ul>
</div>
<br>

<div id="class-container" class="container" style="min-width: 1200px;">
    <div class="main-content" style="min-height: 1000px; margin-right: 20px; padding-left: 20px; padding-top: 20px; padding-bottom: 20px; width: 100%; float: left; min-width: 700px">
        <div id="header" class="flex-div"></div>
        <div id="subheader" class="flex-div"></div>

        <div class="container" id="class-panel">
            <div id="sidebar" class="class-list"></div>
            <div id="class-window" class="flex-div">
                <div id='info-window' style='overflow: hidden; display:none'>
                    <h3 id="labelTitle"></h3>

                    <div class='class-block'>
                        <div class='class-row'>
                            <label id="labelOA"></label>
                        </div>
                        <div class='class-row'>
                            <label id="labelStatus"></label>
                        </div>
                        <div class='class-row'>
                            <label for='blockInicio'><strong>Descripción de inicio:</strong></label>
                            <p id='blockInicio' style='width: 300px;' class='bloque-info'></p>
                        </div>
                        <div class='class-row'>
                            <label for='blockSkill'><strong>Habilidades:</strong></label>
                            <div id='blockSkill' style='width: 300px;' class='bloque-info'>
                                <ul id='skill_info'></ul>
                            </div>
                        </div>
                    </div>

                    <div class='class-block' style='float:right'>
                        <div class='class-row'>
                            <label id="labelDate"></label>
                        </div>
                        <div class='class-row'>
                            <label id='labelDuration'></label>
                        </div>

                        <div class='class-row'>
                            <label for='blockCierre'><strong>Descripción de cierre:</strong></label>
                            <p id='blockCierre' style='width: 300px;' class='bloque-info'></p>
                        </div>
                        <div class='class-row'>
                            <label for='video_block'><strong>Videos:</strong></label>
                            <div id='video_block' style='width: 300px;' class='bloque-info'>
                                <ul id='video_info'>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <br>
                    <div id="log-container" class="class-wide-block">

                    </div>
                </div>
            </div>  
        </div>
    </div>
</div>

<div id="summary-container" class="container">
    <div id="summary-content" class="sum-content">
        <h2>Resumen</h2>
        <label id="teacher_rpLabel"></label><br>
        <label id="student_count_rpLabel"></label><br>
        <label id="plan_count_rpLabel"></label><br>
        <label id="plan_start_date_rpLabel"></label><br>
        <label id="plan_end_date_rpLabel"></label><br>
    </div>

    <div id="bar-content" class="sum-content">
        <h2>Progreso de unidades <img id="planbar_info" style='width:16px; height:16px;' src={% static 'img/info.png' %}></h2>
        <div id="plan-progress"></div>
    </div>

    <div id="timeline-content" class="sum-content">
        <h2>Linea de tiempo <img id="timeline_info" style='width:16px; height:16px;' src={% static 'img/info.png' %}></h2>
        <div id="timeline-progress"></div>
    </div>

    <div id="topbar" style="min-width: 1200px; height: 52px; margin-bottom: -2px; margin-top: 15px; margin-left: 3px;">
        <ul class="tab">
            {% for top in lista_topicos %}
                <li><a id='tab_piechart_{{ forloop.counter0 }}' style="cursor: pointer; min-height 55px" href='#' onclick="cambiarPiechart({{ forloop.counter0 }}); return false;">
                    Unidad {{ top.index }}
                </a></li>
            {% endfor %}
        </ul>
    </div>

    <div id="piechart-content" class="sum-content">
    </div>
</div>

<div id="popup" style="display:none">
    <div class="popup-container">
        <h3 style="text-align: center; color: red">Advertencia</h3>
        <p style="text-align: justify">Esta operación creara una copia de la planificación actual y la asociara al plan de un currículo. Esto sobrescribirá y borrara cualquier planificación realizada en el currículo actual. Esta acción no se puede deshacer.</p>
    </div>
    <div class="popup-container">
        <p style="text-align: justify">Actualmente se esta viendo el plan del curso {{ clase.0.level }} {{ clase.0.letter }} 
        {% if clase.0.additional %}
            ({{clase.0.additional}})
        {% endif %}
        del año {{ clase.0.year }}.<p>
    </div>
    <div class="popup-container">
        <p style="text-align: justify">Esta planificación se copiara currículo ministerial: {{ nivel_curriculo }} {{ anno_curriculo }}.<p>
    </div>

    <a onclick='copyPlan()' class="kui-button kui-button-submit kui-button-primary" style="cursor:pointer; width:80px; height: 35px; padding:8px; margin:10px">Copiar</a>
    <a onclick="hidePopup()" class="kui-button kui-button-plain kui-button-primary" style="display:inline;cursor:pointer; width:80px; height: 35px; padding:8px; margin:10px">Cancelar</a>
</div>

<script type="text/javascript">

    $(document).ready(function(){
        $("#hover").click(function(){
            $(this).fadeOut();
            $("#popup").fadeOut();
            $("#popuptree").fadeOut();
        });
        
        $("#close").click(function(){
            $("#hover").fadeOut();
            $("#popup").fadeOut();
            $("#popuptree").fadeOut();
        });
     });

    function cambiarUnidad(unitid){
        $('#header').empty();
        $('#subheader').empty();
        $('#class-window').hide();

        $("#class-container").show();
        $("#summary-container").hide();

        var curriculo = JSON.parse('{{ json_data | escapejs }}');
        var topicos = curriculo["topicos"];
        var text = "";

        //Dibuja la caja de descripcion de la Unidad.
        for (var i = 0; i < topicos.length; i++) {
            if (topicos[i]['id'] == unitid){
                var subtopicos = topicos[i]["subtopico"];
                text += "<label class='desc_label' style='margin-left: 150px;'>Descripción de la Unidad: </label>";
                text += "<p class='descripcion'>"+topicos[i]['desc']+"</p>";
                text += "<br>";
                break;
            }
        }

        $('#header').append(text);
        text = "";

        text += "<div style='margin-right: 180px; margin-bottom: 10px'>";
        text += "<label for='oa_select'>Objetivo de Aprendizaje: </label>";
        text += "<select id='oa_select' onchange='filtrarOA(" + unitid + ");' class='ui-corner-all simple-input search-input blur-on-esc approvalName' style='padding-left: 0px'>";
        text += "<option value='0' onclick='listarClases(" + unitid + ")'>Mostrar Todo</option>";
        for (var s = 0; s < subtopicos.length; s++){
            text += "<option value='" + subtopicos[s]["id"] + "'> Objetivo de aprendizaje " + subtopicos[s]["index"] + "</option>";
        }
        text += "</select></div>";
        
        $('#header').append(text);

        listarClases(unitid);

        //Cambia estilo (colorea) la pestaña Unidad seleccionada.
        $(document.getElementsByClassName("tab_select")).removeClass("tab_select");
        $(document.getElementById("tab_unidad_" + unitid)).addClass("tab_select");
        $(document.getElementById("class-window")).addClass("class-window");
    }

    function filtrarOA(unitid){
        $('#subheader').empty();

        var filtered_oa_id = $('#oa_select').val();
        var text = "";

        if(filtered_oa_id){
            var curriculo = JSON.parse('{{ json_data | escapejs }}');
            var topicos = curriculo["topicos"];
            
            //Dibuja la caja de descripcion de los OA.
            for (var t = 0; t < topicos.length; t++) {
                if (topicos[t]['id'] == unitid){
                    var subtopicos = topicos[t]["subtopico"];
                    for (var s = 0; s < subtopicos.length; s++){
                        if(subtopicos[s]['id'] == filtered_oa_id){
                            if (subtopicos[s]['resumen']){
                                text += "<div style='margin-left: 140px; margin-right: 185px;'>";
                                    text += "<div style='float: left; width: 400px;'>";
                                        text += "<label class='desc_label'>Descripcion del Objetivo de Aprendizaje: </label>";
                                        text += "<p class='descripcion' style='margin-left: 10px; width: 94%'>"+subtopicos[s]['desc']+"</p>";
                                    text += "</div><div style='float: right; width: 400px;'>";
                                        text += "<label class='desc_label'>Información adicional: </label>";
                                        text += "<p class='descripcion' style='width: 94%; margin-left: 10px'>"+subtopicos[s]['resumen']+"</p>";
                                    text += "</div>";
                                text += "</div>";
                            }else{
                                text += "<label style='margin-left: 5px; width: 400px;'>Descripcion del Objetivo de Aprendizaje: </label>";
                                text += "<p class='descripcion'>"+subtopicos[s]['desc']+"</p>";
                            }
                            text += "<br>";
                            break; break;
                        }
                    }
                }
            }$('#subheader').append(text);
        }
        listarClases(unitid, filtered_oa_id);
    }

    function listarClases(unitid, selected_oa_id = 0){
        $('#sidebar').empty();

        var curriculo = JSON.parse('{{ json_data | escapejs }}');
        var topicos = curriculo["topicos"];
        var planificacion = JSON.parse('{{ plan | escapejs}}');
        var plan_list = planificacion["plan"];
        var text += "<ul>";

        for (var i = 0; i < topicos.length; i++) {
            if (topicos[i]['id'] == unitid){
                var subtopicos = topicos[i]["subtopico"];
                break;
            }
        }
        
        if (selected_oa_id == 0){
            for (var i = 0; i < plan_list.length; i++){
                for (var s = 0; s < subtopicos.length; s++){
                    if (plan_list[i]['class_subtopic'] == subtopicos[s]['id']){
                        text += "<li><a id='tab_clase_" + plan_list[i]['id'] + "' style='cursor: pointer' href='#' onclick='cambiarClase(" + plan_list[i]['id'] + ", " +  unitid + "); return false;'>";
                        if(plan_list[i]["status"]){
                            text += "<div class='box done'></div>";
                        }else if(plan_list[i]["late"]){
                            text += "<div class='box late'></div>";
                        }else{
                            text += "<div class='box not-done'></div>";
                        }
                        text += plan_list[i]['class_name'];
                        text += "</a></li>";
                    }
                }
            }
        }else{
            for (var i = 0; i < plan_list.length; i++){
                if (plan_list[i]['class_subtopic'] == selected_oa_id){
                    text += "<li><a id='tab_clase_" + plan_list[i]['id'] + "' style='cursor: pointer' href='#' onclick='cambiarClase(" + plan_list[i]['id'] + ", " +  unitid + "); return false;'>";
                    if(plan_list[i]["status"]){
                        text += "<div class='box done'></div>";
                    }else if(plan_list[i]["late"]){
                        text += "<div class='box late'></div>";
                    }else{
                        text += "<div class='box not-done'></div>";
                    }
                    text += plan_list[i]['class_name'];
                    text += "</a></li>";
                }
            }
        }
        text += "</ul>";

        $('#sidebar').append(text);
    }

    function cambiarClase(classid, unitid){
        $('#class-window').show();
        $('#info-window').hide();

        var topic_dump = JSON.parse('{{ json_data | escapejs }}');
        var plan_dump = JSON.parse('{{ plan | escapejs}}');
        var log_dump = JSON.parse("{{ log | escapejs }}");
        var topicos = topic_dump["topicos"];
        var plan_list = plan_dump["plan"];
        var logs = log_dump["info"];

        for (var i = 0; i < topicos.length; i++) {
            if (topicos[i]['id'] == unitid){
                var subtopicos = topicos[i]["subtopico"];
                break;
            }
        }

        var Lista_Meses = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
        var filtered_oa_id = $('#oa_select').val();
        
        //Inserta en la ventana que muestra contenido los datos de la clase.

        for(var i = 0; i < plan_list.length; i++){
            if(plan_list[i]["id"] == classid){
                //Busca el index del O.A.
                for(var s = 0; s < subtopicos.length; s++){
                    if(subtopicos[s]['id'] == plan_list[i]['class_subtopic']){
                        var oa_index = subtopicos[s]['index'];
                        break;
                    }
                }
                $('#labelTitle').html(plan_list[i]["class_name"]);
                $('#labelOA').html("<strong>Objetivo de aprendizaje:</strong> " + oa_index);                    
                $('#blockInicio').html(plan_list[i]["desc_inicio"]);
                $('#blockCierre').html(plan_list[i]["desc_cierre"]);
                $('#labelDate').html("<strong>Fecha:</strong> " + plan_list[i]["class_date"][2] + " de " + Lista_Meses[plan_list[i]["class_date"][1]-1] + " de " + plan_list[i]["class_date"][0]);
                $('#labelDuration').html("<strong>Duración:</strong> " + plan_list[i]["minutes"] + " minutos");

                $('#labelStatus').html("<strong>Estado: </strong>");
                if (plan_list[i]["status"] == true) $('#labelStatus').append("Realizado");
                else{
                    if (plan_list[i]["late"] == true) $('#labelStatus').append("Atrasado");
                    else $('#labelStatus').append("No realizado");
                }
                for (var v = 0; v < plan_list[i]["videos"].length; v++){
                    var text = "<li key=" + plan_list[i]["videos"][v]["id"] + " tree='" + plan_list[i]["videos"][v]["tree"] + "'>";
                    text += "<img style='width:15px; height:15px;' src={% static 'img/videos.png' %} alt='Videos'>";
                    text += plan_list[i]["videos"][v]["nombre"];
                    text += "</li>";
                    $("#video_info").append(text);
                }

                for (var s = 0; s < plan_list[i]["skills"].length; s++){
                    var text = "<li key=" + plan_list[i]["skills"][s]["id"] + " tree='" + plan_list[i]["skills"][s]["tree"] + "'>";
                    text += "<img style='width:15px; height:15px;' src={% static 'img/ejercicios.png' %} alt='Habilidades'>";
                    text += plan_list[i]["skills"][s]["nombre"];
                    text += "</li>";
                    $("#skill_info").append(text);
                }

                var log_exist = false
                $("#log-container").html("<h3>Historial de cambios");
                $("#log-container").append("<table id='log-table' class='log-table'>");
                $("#log-table").append("<tr><th style='width: 120px;'>Fecha del cambio</th><th style='width: 120px'>Campo editado</th><th>Valor original</th><th>Valor nuevo</th>");

                for (var l = 0; l < logs.length; l++){

                    if(logs[l]["id_planning"] == classid){
                        log_exist = true;
                        $("#log-table").append("<tr><td class='table-cell'>" + logs[l]["date"] + "</td><td class='table-cell'>" + logs[l]["field"] + "</td><td class='table-cell'>" + logs[l]["old_value"] + "</td><td class='table-cell'>" + logs[l]["new_value"] + "</td>");
                    }
                }
                if(!log_exist) $("#log-container").empty();

                $("#info-window").show();
                break;
            }
        }

        $(document.getElementsByClassName("select")).removeClass("select");
        $(document.getElementById("tab_clase_" + classid)).addClass("select");
    }

    var firstTimeOpen = true;
    function mostrarResumen(){
        $(document.getElementsByClassName("tab_select")).removeClass("tab_select");
        $(document.getElementById("tab_resumen")).addClass("tab_select");
        $(document.getElementById("class-window")).addClass("class-window");

        $("#class-container").hide();
        $("#summary-container").show();

        if(firstTimeOpen){
            retrieveReport();
            firstTimeOpen = false;
        }
    }

    function retrieveReport(){
        $.ajax({
            url: "{% url 'planificacion:obtener_datos' %}",
            type: "GET",
            data: { "subj_class_id" : {{ id }},
            },
            success: function(response){
                $("#teacher_rpLabel").html("Profesor: " + response["teacher_name"])
                $("#student_count_rpLabel").html("Número de estudiantes: " + response["nStudents"]);
                $("#plan_count_rpLabel").html("Número de planes realizados: " + response["nPlans"]);
                $("#plan_start_date_rpLabel").html("Fecha de inicio: " + response["start_date"].join("/"));
                $("#plan_end_date_rpLabel").html("Fecha final: " + response["end_date"].join("/"));

                loadPlanBar();
                loadTimeline(response["time"]);
                loadPieChart(response["skills"]);
                cambiarPiechart(0);
                loadToolkit();
            },
            error: function(response, error){
                alert("Error: " + response.length);
            }
        });
    }

    function loadPlanBar(){
        var planificacion = JSON.parse('{{ plan | escapejs}}');
        var plan_list = planificacion["plan"];
        var curriculo = JSON.parse('{{ json_data | escapejs }}');
        var unidades = curriculo["topicos"];
        var hora_unidades = new Array();
        var hora_planeadas = Array.apply(null, Array(unidades.length)).map(Number.prototype.valueOf,0);

        for (var u = 0; u < unidades.length; u++){
            hora_unidades.push(unidades[u]["horas"]);
            
            var objetivos = unidades[u]["subtopico"];
            for (var ob = 0; ob < objetivos.length; ob++){
                for (var p = 0; p < plan_list.length; p++){
                    if(plan_list[p]["class_subtopic"] == objetivos[ob]['id']){
                        hora_planeadas[u] += plan_list[p]["minutes"]/45;
                    }
                }
            }
        }

        $("#plan-progress").empty();

        for (var i = 0; i < hora_unidades.length; i++){
            var margin = {top: 0, right: 0, bottom: 0, left: 0};
            var width = 400 - margin.left - margin.right, 
                height = 24 - margin.top - margin.bottom;

            var data = [hora_unidades[i], hora_planeadas[i]];
            if (hora_unidades[i] <= hora_planeadas[i]) data[1] = hora_unidades[i];

            var percent = Math.round(data[1] * 100 / data[0]);

            $("#plan-progress").append("<div id='percentbar-" + i + "' style='display: block; width: 100%; height: 30px'>")
            $("#percentbar-" + i).append("<div style='position:absolute; margin-top: 2px; margin-right: 6px;'> Unidad " + (i + 1) + ": ");

            var chart = d3.select("#percentbar-" + i).append("svg") // creating the svg object inside the container div
                .attr("class", "chart")
                .attr("style", "margin-left: 80px")
                .attr("width", width) // bar has a fixed width
                .attr("height", height);
            
            var x = d3.scale.linear() // takes the fixed width and creates the percentage from the data values
                .domain([0, data[0]])
                .range([0, width]); 
              
            chart.selectAll("rect") // this is what actually creates the bars
                .data(data)
            .enter().append("rect")
                .attr("width", x)
                .attr("height", height)
                .attr("rx", 5) // rounded corners
                .attr("ry", 5);
            
            if(percent > 5){
                chart.selectAll("text") // adding the text labels to the bar
                    .data(data)
                .enter().append("text")
                    .filter(function (d, i) {return i === 1;})
                    .attr("x", x)
                    .attr("y", 10) // y position of the text inside bar
                    .attr("dx", -3) // padding-right
                    .attr("dy", ".35em") // vertical-align: middle
                    .attr("text-anchor", "end") // text-align: right
                    .text(percent + "%");
            }

            $("#percentbar-" + i).append("<div style='position:absolute; margin-top: -28px; margin-left: 500px;'> Horas planificadas: " + hora_planeadas[i] + " Horas sugeridas: " + hora_unidades[i] + "<br>");
        }
    }

    function loadTimeline(tD){
        var planificacion = JSON.parse('{{ plan | escapejs}}');
        var plan_list = planificacion["plan"];
        var Mes = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        var colorScale = d3.scale.ordinal().range(['#0094FF','#FF5656','#FFDF42'])
            .domain(['done','late','not-done']);

        var margin = {left: 80, right: 10, top: 10, bottom: 40};

        var chart = d3.timeline()
                .colors( colorScale )
                .colorProperty('ctype')
                .showTimeAxisTick()
                .stack()
                .margin(margin)
                .showToday()
                .display("circle")
                .tickFormat({
                        format: d3.time.format("%B"),
                        tickTime: d3.time.months,
                        tickSize: 16
                });

        chart.click(function(d, i, datum){
            cambiarUnidad(datum.unit_id);
            cambiarClase(d.plan_id,datum.unit_id);
        });


        var svg = d3.select("#timeline-progress").append("svg").attr("width", 1150)
                    .datum(tD)
                    .call(chart);

        //Pinta el texto de los labels a negro.
        $(".timeline-label").css("fill", "black");
        $("g .axis .tick text").css("fill", "black");
        for (var u = 0; u < tD.length; u++){
            $(".timelineSeries_"+u).attr("r",8);
            $(".timelineSeries_"+u).qtip({
                content: function() {
                    $(this).attr("fill", "red");
                    var b = $(this).prop("__data__");

                    var tooltip = "<ul>";
                    for (var i = 0; i < plan_list.length; i++){
                        if(plan_list[i]["id"] == b.plan_id){
                            var date = String(plan_list[i]["class_date"]).split(",");

                            tooltip += "<li style='text-align:left;'><strong>Clase: </strong>" + plan_list[i]["class_name"] + "</li>";
                            tooltip += "<li style='text-align:left;'><strong>Fecha: </strong>" + date[2] + " de " + Mes[date[1]-1] + " de " + date[0] + "</li>";
                            tooltip += "<li style='text-align:left;'><strong>Duración: </strong>" + plan_list[i]["minutes"] + " minutos</li>";
                            if(plan_list[i]["status"]){
                                tooltip += "<li style='text-align:left;'><strong>Estado: </strong>Realizada</li>";
                            }
                            else if(plan_list[i]["late"]){
                                tooltip += "<li style='text-align:left;'><strong>Estado: </strong>Atraasdo</li>";
                            }
                            else{
                                tooltip += "<li style='text-align:left;'><strong>Estado: </strong>No realizada</li>";
                            }
                        }
                    }
                    tooltip += '</ul>';
                    return tooltip
                },
                show: { 
                    event: 'mouseenter', 
                    delay: 10, 
                    solo: true,   
                    effect: function(offset) {$(this).slideDown(100);}  
                },
                   
                hide: { 
                    event: 'mouseleave', 
                    delay: 90, 
                    fixed: true 
                },

                position: { 
                    my: 'bottomLeft',
                    at: 'topMiddle',
                    adjust: {y: 10}
                }
            });
        }
    }

    var histArray = [];
    var pieArray = [];
    var legendArray = [];
    var barColor = "#41ab5d";
    var segColor = {mastery3:"#1C758A", mastery2:"#29ABCA", mastery1:"#58C4DD", practiced:"#9CDCEB", unstarted:"#A0A0A0", struggling:"#C30202"};
    function loadPieChart(data){
        var planificacion = JSON.parse('{{ plan | escapejs}}');
        var plan_list = planificacion["plan"];
        var curriculo = JSON.parse('{{ json_data | escapejs }}');
        var unidades = curriculo["topicos"];
        
        for(var unidad = 0; unidad < data.length; unidad++){
            if (data[unidad].length != 0){
                data[unidad].forEach(function(d){ d.total = d.level.mastery3 + d.level.mastery2 + d.level.mastery1 + d.level.practiced ;});

                var tF = ["mastery3", "mastery2", "mastery1", "practiced", "unstarted", "struggling"].map(function(d){ 
                    return {
                        type:d, freq: d3.sum(data[unidad].map(function(t){
                            return t.level[d];
                        }))
                    }; 
                });

                $("#piechart-content").append("<div id='piechart-" + unidad + "' class='piechart'><h2>Habilidades dominadas en la unidad " + (unidad + 1) + " <img class='piechart_info' style='width:16px; height:16px;' src={% static 'img/info.png' %}></h2><div id='piechart-graph-" + unidad + "' style='float:left'></div><div id='piechart-leg-" + unidad + "' style='float:left; margin-left: 100px'></div><div id='piechart-hist-" + unidad + "' style='width: 1050px;float:left'></div><br>");

                var sF = data[unidad].map(function(d){return [d.name,d.total];});

                histArray.push(drawHistogram(sF, tF, data[unidad], unidad));
                pieArray.push(drawPiechart(tF, data[unidad], unidad));
                legendArray.push(drawLegend(tF, data[unidad], unidad));
            }
        }
    }

    function drawHistogram(fD, tF, fData, index){
        var id = "#piechart-hist-" + index;
        var margin = {top: 30, right: 20, bottom: 150, left: 0};
        var width = 1050 - margin.left - margin.right, 
            height = 420 - margin.top - margin.bottom;
            
        //create svg for histogram.
        var hGsvg = d3.select(id).append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom).append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // create function for x-axis mapping.
        var x = d3.scale.ordinal().rangeRoundBands([0, width], 0.1)
                .domain(fD.map(function(d) { return d[0]; }));

        // Add x-axis to the histogram svg.
        hGsvg.append("g").attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.svg.axis().scale(x).orient("bottom"))
        .selectAll("text")
            .style("fill", "black")
            .attr("y", 0)
            .attr("x", 9)
            .attr("dy", ".35em")
            .attr("transform", "rotate(70)")
            .style("text-anchor", "start");

        // Create function for y-axis map.
        var y = d3.scale.linear().range([height, 0])
                .domain([0, d3.max(fD, function(d) { return d[1]; })]);

        // Create bars for histogram to contain rectangles and freq labels.
        var bars = hGsvg.selectAll(".bar").data(fD).enter()
                .append("g").attr("class", "bar");
        
        //create the rectangles.
        bars.append("rect")
            .attr("x", function(d) { return x(d[0]); })
            .attr("y", function(d) { return y(d[1]); })
            .attr("width", x.rangeBand())
            .attr("height", function(d) {return height - y(d[1]); })
            .style('fill', barColor)
            .on("mouseover",mouseover)// mouseover is defined below.
            .on("mouseout",mouseout);// mouseout is defined below.
            
        //Create the frequency labels above the rectangles.
        bars.append("text").text(function(d){ return d3.format(",")(d[1])})
            .attr("x", function(d) { return x(d[0])+x.rangeBand()/2; })
            .attr("y", function(d) { return y(d[1])-5; })
            .attr("text-anchor", "middle")
            .style("fill", "black");
        
        function mouseover(d){  // utility function to be called on mouseover.
            // filter for selected state.
            bars.select("rect").transition().duration(500)
                .style("fill", barColor);

            var st = fData.filter(function(s){ return s.name == d[0];})[0],
                nD = ["mastery3", "mastery2", "mastery1", "practiced", "unstarted", "struggling"].map(function(s){
                    return {type:s, freq:st.level[s]};
                });
               
            // call update functions of pie-chart and legend.    
            pieArray[index].update(nD);
            legendArray[index].update(nD);
        }
        
        function mouseout(d){    // utility function to be called on mouseout.
            // reset the pie-chart and legend.
            bars.select("rect").transition().duration(500)
                .style("fill", barColor);

            pieArray[index].update(tF);
            legendArray[index].update(tF);
        }
        
        // create function to update the bars. This will be used by pie-chart.
        var histogram = {};
        histogram.update = function(nD, color){
            // update the domain of the y-axis map to reflect change in frequencies.
            y.domain([0, d3.max(nD, function(d) { return d[1]; })]);
            
            // Attach the new data to the bars.
            var bars = hGsvg.selectAll(".bar").data(nD);
            
            // transition the height and color of rectangles.
            bars.select("rect").transition().duration(500)
                .attr("y", function(d) {return y(d[1]); })
                .attr("height", function(d) { return height - y(d[1]); })
                .style("fill", color);

            // transition the frequency labels location and change value.
            bars.select("text").transition().duration(500)
                .text(function(d){ return d3.format(",")(d[1])})
                .attr("y", function(d) {return y(d[1])-5; });            
        }
        

        return histogram;
    }

    function drawPiechart(pD, fData, index){
        var id = "#piechart-graph-" + index;
        var pC ={}, pieDim ={w:300, h: 300};
        var margin = {left: 100, right: 0, top: 0, bottom: 0};
        pieDim.r = Math.min(pieDim.w, pieDim.h) / 2;
                
        // create svg for pie chart.
        var piesvg = d3.select(id).append("svg")
            .attr("width", pieDim.w).attr("height", pieDim.h).append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .attr("transform", "translate("+pieDim.w/2+","+pieDim.h/2+")");
        
        // create function to draw the arcs of the pie slices.
        var arc = d3.svg.arc().outerRadius(pieDim.r - 10).innerRadius(0);

        // create a function to compute the pie slice angles.
        var pie = d3.layout.pie().sort(null).value(function(d) { return d.freq; });

        // Draw the pie slices.
        piesvg.selectAll("path").data(pie(pD)).enter().append("path").attr("d", arc)
            .each(function(d) { this._current = d; })
            .style("fill", function(d) { return segColor[d.data.type]; })
            .on("mouseover",mouseover).on("mouseout",mouseout);;

        // create function to update pie-chart. This will be used by histogram.
        pC.update = function(nD){
            piesvg.selectAll("path").data(pie(nD)).transition().duration(500)
                .attrTween("d", arcTween);
        }

        // Utility function to be called on mouseover a pie slice.
        function mouseover(d){
            // call the update function of histogram with new data.
            histArray[index].update(fData.map(function(v){
                return [v.name,v.level[d.data.type]];
            }), segColor[d.data.type]);
        }
        //Utility function to be called on mouseout a pie slice.
        function mouseout(d){
            // call the update function of histogram with all data.
            histArray[index].update(fData.map(function(v){
                return [v.name,v.total];}), barColor);
        }

        // Animating the pie-slice requiring a custom function which specifies
        // how the intermediate paths should be drawn.
        function arcTween(a) {
            var i = d3.interpolate(this._current, a);
            this._current = i(0);
            return function(t) { return arc(i(t));    };
        }

        return pC;
    }
    
    function drawLegend(lD, fData, index){
        var id = "#piechart-leg-" + index;
        var segColor = {mastery3:"#1C758A", mastery2:"#29ABCA", mastery1:"#58C4DD", practiced:"#9CDCEB", unstarted:"#A0A0A0", struggling:"#C30202"}
        var leg = {};
            
        // create table for legend.
        var legend = d3.select(id).append("table").attr('class','legend');
        
        // create one row per segment.
        var tr = legend.append("tbody").selectAll("tr").data(lD).enter().append("tr");
            
        // create the first column for each segment.
        tr.append("td").append("svg").attr("width", '16').attr("height", '16').append("rect")
            .attr("width", '16').attr("height", '16')
            .attr("fill",function(d){ return segColor[d.type]; });
            
        // create the second column for each segment.
        tr.append("td").text(function(d){
            switch (d.type){
                case "mastery3":
                    return "Dominado";
                case "mastery2":
                    return "Nivel 2";
                case "mastery1":
                    return "Nivel 1";
                case "practiced":
                    return "Practicado";
                case "unstarted":
                    return "Sin realizar";
                case "struggling":
                    return "Con problema";
            }
        }).attr("width", '200');

        // create the third column for each segment.
        tr.append("td").attr("class",'legendFreq')
            .text(function(d){ return d3.format(",")(d.freq);});

        // create the fourth column for each segment.
        tr.append("td").attr("class",'legendPerc')
            .text(function(d){ return getLegend(d,lD);});

        tr.append("td").append("input").attr("class","legend-checkbox-" + index)
            .attr("type","checkbox")
            .attr("value", function(d){return d.type})
            .property("checked", function(d){
                if (d.type == "mastery3" || d.type == "mastery2" || d.type == "mastery1" || d.type == "practiced"){
                    return true;
                }else{
                    return null;
                }
            })
            .on("change", updateHisto);

        // Utility function to be used to update the legend.
        leg.update = function(nD){
            // update the data attached to the row elements.
            var l = legend.select("tbody").selectAll("tr").data(nD);

            // update the frequencies.
            l.select(".legendFreq").text(function(d){ return d3.format(",")(d.freq);});

            // update the percentage column.
            l.select(".legendPerc").text(function(d){ return getLegend(d,nD);});        
        }
        
        function getLegend(d,aD){ // Utility function to compute percentage.
            return String(Math.round(d.freq * 1000/d3.sum(aD.map(function(v){ return v.freq; })))/10) + "%";
        }

        function updateHisto(d){
            var filter = [];

            d3.selectAll(".legend-checkbox-" + index).each(function(v){
                cb = d3.select(this);
                if (cb.property("checked")){
                    filter.push(cb.attr("value"));
                }
            });

            fData.forEach(function(v){
                v.total = 0;
                filter.forEach(function(e){
                    v.total += v.level[e];
                });
            });

            histArray[index].update(fData.map(function(v){
                return [v.name,v.total];}), barColor);
        }
        

        return leg;
    }

    function cambiarPiechart(index){
        $("#piechart-content").children().hide();
        $("#piechart-" + index).show();
        $(".pie_select").removeClass("pie_select");
        $("#tab_piechart_" + index).addClass("pie_select");
    }

    function loadToolkit(){
        $("#planbar_info").qtip({
            content: function() {
                return "Muestra el progreso de horas pedagógicas planificadas en comparación a las horas recomendadas según lo especificado en el currículo ministerial.";
            },
            show: { 
                event: 'mouseenter', 
                delay: 10, 
                solo: true,   
                effect: function(offset) {$(this).slideDown(100);}  
            },
               
            hide: { 
                event: 'mouseleave', 
                delay: 90, 
                fixed: true 
            },

            position: { 
                my: 'bottomLeft',
                at: 'topMiddle',
                adjust: {y: 10}
            }
        });

        $("#timeline_info").qtip({
            content: function() {
                return "Muestra las clases planificadas en una linea de tiempo, colocar el puntero por sobre una fecha despliega información básica de la clase, con un click se muestra la clase en la lista de clases planificadas.";
            },
            show: { 
                event: 'mouseenter', 
                delay: 10, 
                solo: true,   
                effect: function(offset) {$(this).slideDown(100);}  
            },
               
            hide: { 
                event: 'mouseleave', 
                delay: 90, 
                fixed: true 
            },

            position: { 
                my: 'bottomLeft',
                at: 'topMiddle',
                adjust: {y: 10}
            }
        });

        $(".piechart_info").each(function(){
            $(this).qtip({
                content: function() {
                    return "Muestra gráficos relacionados al nivel de dominio de los alumnos de la clase sobre las habilidades que son parte de las clases planificadas. El gráfico circular muestra la distribución del nivel de dominio de cada alumno en cada habilidad. Los gráficos de barra representa los alumnos que alcanzaron los niveles de dominio seleccionados en cada habilidad. colocar el puntero sobre uno de los gráficos permite visualizar en los otros gráficos la categoría respectiva.";
                },
                show: { 
                    event: 'mouseenter', 
                    delay: 10, 
                    solo: true,   
                    effect: function(offset) {$(this).slideDown(100);}  
                },
                   
                hide: { 
                    event: 'mouseleave', 
                    delay: 90, 
                    fixed: true 
                },

                position: { 
                    my: 'bottomLeft',
                    at: 'topMiddle',
                    adjust: {y: 10}
                }
            });
        });
    }

    function copyPlan(){
        original_id = {{ id }};

        $.ajax({
                url: "{% url 'planificacion:copiar_plan_inst' %}",
                type: "POST",
                data: {copied_class_id: original_id
                    },
                success: function(response){
                    $("#popup").empty()
                    $("#close").hide();
                    $("#hover").fadeIn();
                    $("#popup").fadeIn();
                    $("#popup").append("<p class='response'>"+response+"</p>");

                    $("#hover").css('pointer-events','none');
                    $("#close").css('pointer-events','none');
                    window.setTimeout(function(){
                        location.reload()
                    },500);
                },
                error: function(response){
                    $("#popup").empty()
                    $("#hover").fadeIn().css('display', '');
                    $("#popup").fadeIn().css('display', '');
                    console.log(response);
                    $("#popup").append("<p class='response'>Hubo un error en el copiado de datos.</p>");
                }
            });
    }

    function hideTree(){
        $('#popuptree').hide();
        $('#hover').hide();
    }

    function hidePopup(){
        $('#popup').hide();
        $('#hover').hide();
    }

    function copyWarning(classid){
      $('#hover').fadeIn();
      $('#popup').fadeIn();
    }

</script>
{% endblock %}