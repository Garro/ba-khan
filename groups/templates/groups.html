{% extends 'home.html' %}
{% load static %}
{% load  smart_if %}

{% block title %}
	Grupos
{% endblock %}

{% block body2 %}
	<head>
		<script>

		        function start(e) {
		            e.dataTransfer.effecAllowed = 'move'; // Define el efecto como mover (Es el por defecto)
		            e.dataTransfer.setData("Data", e.target.id); // Coje el elemento que se va a mover
		            e.dataTransfer.setDragImage(e.target, 70, 2.5); // Define la imagen que se vera al ser arrastrado el elemento y por donde se coje el elemento que se va a mover (el raton aparece en la esquina sup_izq con 0,0)
		            e.target.style.opacity = '0.4'; 
		        }
		
		        function end(e){
		            e.target.style.opacity = ''; // Pone la opacidad del elemento a 1           
		            e.dataTransfer.clearData("Data");
		        }

		           function over(e) {
       
				           var elemArrastrable = e.dataTransfer.getData("Data"); // Elemento arrastrado
				           var id = e.target.id; // Elemento sobre el que se arrastra
				           
				           // return false para que se pueda soltar
				           if (id == 'Reforzamiento'){
				               return false; // Cualquier elemento se puede soltar sobre el div destino 1
				           }
				           if (id == 'Intermedios'){
				               return false; 
				           }   
				           if (id == 'Avanzados'){
				               return false;
				   
				}
				           if (id == 'SinGrupo'){
				               return false;
				           }
				           if (id == 'SubGrupoReforzamiento'){
				               return false;
				   
				}
				   
				if (id == 'SubGrupoIntermedios'){
				               return false;
				   
				}
				   
				if (id == 'SubGrupoAvanzados'){
				               return false;
				   
				}
				               
				       }

		    
		        /**
		        * 
		        * Mueve el elemento
		        *
		        **/
		        function fillComboBox(){
		        	$('select').empty();
					$("#comboBoxAvanzados").append("<OPTION VALUE=1>Seleccionar Tutor</OPTION>");
					   $("#comboBoxIntermedios").append("<OPTION VALUE=2>Seleccionar Tutor</OPTION>");
					   $("#comboBoxReforzamiento").append("<OPTION VALUE=3>Seleccionar Tutor</OPTION>");
					   
					   $("#comboBoxAvanzados").append("<OPTION VALUE=1>{{ request.user.username }}</OPTION>");
					   $("#comboBoxIntermedios").append("<OPTION VALUE=2>{{ request.user.username }}</OPTION>");
					   $("#comboBoxReforzamiento").append("<OPTION VALUE=3>{{ request.user.username }}</OPTION>");
					var divs = document.querySelectorAll('.cuadradito');
					   for (var i = 0; i < divs.length; i++) {
					       var id1 = divs[i].getAttribute('id');
					       var id2 = divs[i].getAttribute('title');
					    
					var id3 = divs[i].getAttribute('name');
					       

					if(id3=="Avanzados" || id3=="SubGrupoAvanzados"){
					       
					$("#comboBoxIntermedios").append("<OPTION VALUE="+id1+">"+id2+"</OPTION>");
					       
					$("#comboBoxReforzamiento").append("<OPTION VALUE="+id1+">"+id2+"</OPTION>");
					}
					if(id3=="Intermedios" || id3=="SubGrupoIntermedios"){
					       
					$("#comboBoxReforzamiento").append("<OPTION VALUE="+id1+">"+id2+"</OPTION>");
					}
					   }   
					};
		         function drop(e){
					           var elementoArrastrado = e.dataTransfer.getData("Data"); // Elemento arrastrado
					           
					           document.getElementById(elementoArrastrado).setAttribute("name",e.target.id);
					           
					           
					//rellenamos los comboBox con tutores dependiendo de el grupo en el que esten
								fillComboBox();

					           e.target.appendChild(document.getElementById(elementoArrastrado));
					           e.target.style.border = '';  // Quita el borde

					           tamElemX = $('#'+elementoArrastrado).width();
					           tamElemY = $('#'+elementoArrastrado).height();
					   
					           posXCont = $('#'+e.target.id).position().left;
					           posYCont = $('#'+e.target.id).position().top;
					           // Posicion absoluta del raton
					           x = e.layerX;
					           y = e.layerY;
					           // Si parte del elemento que se quiere mover se queda fuera se cambia las coordenadas para que no sea asi
					           if (posXCont + tamContX <= x + tamElemX){
					               x = posXCont + tamContX - tamElemX - 15;
					           }
					           if (posYCont + tamContY <= y + tamElemY){
					               y = posYCont + tamContY - tamElemY;
					           }
					           document.getElementById(elementoArrastrado).style.position = "absolute";
					           document.getElementById(elementoArrastrado).style.left = x + "px";
					           document.getElementById(elementoArrastrado).style.top = y + "px";

					       }
					       
					function crearSubGrupoAvanzados() {
					var numDiv = document.getElementsByTagName("div").length;
					   $("#Avanzados").append("<div id='SubGrupoAvanzados' class='subGrupo' title='"+numDiv+"' ondragenter='return enter(event)' ondragover='return over(event)' ondragleave='return leave(event)' ondrop='return drop(event)' >SubGrupo Avanzados</div>");

					};
					function crearSubGrupoIntermedios() {
					var numDiv = document.getElementsByTagName("div").length;
					   $("#Intermedios").append("<div id='SubGrupoIntermedios' class='subGrupo' title='' ondragenter='return enter(event)' ondragover='return over(event)' ondragleave='return leave(event)' ondrop='return drop(event)' >SubGrupo Intermedios</div>");
					};
					function crearSubGrupoReforzamiento() {
					var numDiv = document.getElementsByTagName("div").length;
					   $("#Reforzamiento").append("<div id='SubGrupoReforzamiento' class='subGrupo' title='' ondragenter='return enter(event)' ondragover='return over(event)' ondragleave='return leave(event)' ondrop='return drop(event)' >SubGrupo Reforzamiento</div>");
					};

		        
		        function makeGroups() {
				   $.ajax({
						    url: "{% url 'groups:getGroups' id_class %}",
						    type: "POST",
						    data: $("#formJson").serialize(),
						    success: function (response) {
						    	$('.cuadradito').remove();
						       var student = JSON.parse(response);
						       for(var i=0;i<student.length;i++){
						       	if(student[i]['type']=='reinforcement'){
						       		$("#Reforzamiento").append("<div title="+student[i]['name']+" class='cuadradito' name='Reforzamiento' id="+student[i]['kaid_student']+" draggable='true' ondragstart='start(event)' ondragend='end(event)'>"+student[i]['name']+"</div>");
						       	}
						       	if(student[i]['type']=='intermediate'){
						       		$("#Intermedios").append("<div title="+student[i]['name']+" class='cuadradito' name='Intermedios' id="+student[i]['kaid_student']+" draggable='true' ondragstart='start(event)' ondragend='end(event)'>"+student[i]['name']+"</div>");
						       	}
						       	if(student[i]['type']=='advanced'){
						       		$("#Avanzados").append("<div title="+student[i]['name']+" class='cuadradito' name='Avanzados' id="+student[i]['kaid_student']+" draggable='true' ondragstart='start(event)' ondragend='end(event)'>"+student[i]['name']+"</div>");
						       	}	
						       }
						       fillComboBox()
						       alert('Agrupacion realizada correctamente.');
						    }
						});
				 };


				function saveGroups(){
					var divs = document.querySelectorAll('.cuadradito');
				   var jsonArr = [];
				   var aux = false;
				   for (var i = 0; i < divs.length; i++) {
				       	var kaid = divs[i].getAttribute('id');
						var group = divs[i].getAttribute('name');
						if(group=='Avanzados' || group=='Intermedios' || group=='Reforzamiento'){
							aux = true;
						}
						jsonArr.push({
					        kaid_student: kaid,
					        group: group
					    });
				   	}
				   	var tutorsArr = [];
				   	tutorsArr.push({
				   		kaid_tutor_reforzamiento:$('#comboBoxReforzamiento').val(),
				   		kaid_tutor_intermedios:$('#comboBoxIntermedios').val(),
				   		kaid_tutor_avanzados:$('#comboBoxAvanzados').val()
				   	});
				   	$("input[name='tutors']").val(JSON.stringify(tutorsArr));
				   	$("input[name='student_groups']").val(JSON.stringify(jsonArr));
				   	if(aux){

				   		$.ajax({
						    url: "{% url 'groups:getGroups' id_class %}",
						    type: "POST",
						    data: $("#formJson").serialize(),
						    success: function (response) {
						       //lo que haces si es exitoso
						       alert('Grupos guardados correctamente.');
						       location.reload();
						    }
						});
				   		aux = false;
				   	}else{
				   		alert('No hay agrupacion para guardar')
				   	}
					
				};
		
		</script>
	</head>
	    <style>
			#SinGrupo, #Avanzados, #Intermedios, #Reforzamiento {
			   float: left;
			   width: 15.4%;
			   height: 400px;
			   padding: 10px;
			   margin: 10px;
			   text-align: center;
			overflow-y: scroll;
			   border: 1px solid #D9D9D9;
			   border-radius: 5px;
			}

			#SinGrupo{
			   background: #FFFFFF;
			}

			#Avanzados {
			   background: #B6D7A8;
			}
			#Intermedios {
			   background: #FFE599;
			}
			#Reforzamiento {
			   background: #EA9999;
			}
			.cuadradito {
			   background: #F5F5F5;
			   border: 1px solid #D9D9D9;
			   border-radius: 3px;
			   width: 140px;
			   height: 5px;
			   padding: 0 10px 15px;
			   margin: 5px;
			   cursor: move;
			   word-wrap: break-word;
			   overflow: hidden;
			}
			.subGrupo {
			   background: #FFFFFF;
			   border: 1px solid #000000;
			   border-radius: 3px;
			   width: 170px;
			   height: 140px;
			   padding: 0 0px 15px;
			   margin: 0px;
			   word-wrap: break-word;
			   overflow: hidden;
			   background: rgba(255, 255, 255, 0.2);
			}

		#topictree{
			overflow-y: scroll;
			height: 400px;
			padding: 10px;
		    margin: 10px;
		}

    </style>
    <section>
    	
			        <div id="SinGrupo" ondragenter="return enter(event)" ondragover="return over(event)" ondragleave="return leave(event)" ondrop="return drop(event)" ><ul>No agrupados</ul>  
							
			        </div>
 
		        	<div id="Avanzados" ondragenter="return enter(event)" ondragover="return over(event)" ondragleave="return leave(event)" ondrop="return drop(event)"><ul>Avanzados</ul>
		        		<SELECT id="comboBoxAvanzados" NAME="comboBox" style="width: 90%" SIZE=1> 
						<OPTION VALUE="tutores">Seleccionar Tutor</OPTION>
						</SELECT>
						<button onclick="crearSubGrupoAvanzados(this);">nuevo sub-grupo</button>
		        	</div>
 
		        <div id="Intermedios" ondragenter="return enter(event)" ondragover="return over(event)" ondragleave="return leave(event)" ondrop="return drop(event)">Intermedios
		        	 <SELECT id="comboBoxIntermedios" NAME="selCombo" style="width: 90%" SIZE=1 onChange=""> 
					<OPTION VALUE="link pagina 1">Seleccionar Tutor</OPTION>
					</SELECT>
					<button onclick="crearSubGrupoIntermedios(this);">nuevo sub-grupo</button>
		        </div>
		        <div id="Reforzamiento" ondragenter="return enter(event)" ondragover="return over(event)" ondragleave="return leave(event)" ondrop="return drop(event)">Reforzamiento
		        	<SELECT id="comboBoxReforzamiento" NAME="selCombo" style="width: 90%" SIZE=1 onChange=""> 
					<OPTION VALUE="link pagina 1">Seleccionar Tutor</OPTION>
					</SELECT>
					<button onclick="crearSubGrupoReforzamiento(this);">nuevo sub-grupo</button>
		        </div>

	        <div id="topictree">
			</div>
 
    </section>
	<form action="" method="post" id='formJson'>{% csrf_token %}
        <input name="skills" type="hidden" value="[]">
        <input name="student_groups" type="hidden" value=''>
        <input name="tutors" type="hidden" value=''>
        <input type='button' onclick='saveGroups()' class="kui-button kui-button-plain kui-button-primary" value='Guardar'>
        <input type='button' onclick='makeGroups()' class="kui-button kui-button-plain kui-button-primary" value='Realizar Agrupacion'>
    </form> 
    {% if messages %}
	<ul class="messages">
	    {% for message in messages %}
	    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
	    {% endfor %}
	</ul>
	{% endif %}

		<script type="text/javascript">
		  $(document).ready(function(){
		  	{% if students %}
				{% for student in students %}
					{% if student.type == 'ungrouped' %}
						$("#SinGrupo").append("<div title='{{ student.name }}'  class='cuadradito' name='SinGrupo' id='{{ student.kaid_student }}' draggable='true' ondragstart='start(event)' ondragend='end(event)'>{{ student.name }}</div>");
					{% endif%}
					{% if student.type == 'reinforcement' %}
						$("#Reforzamiento").append("<div title='{{ student.name }}' class='cuadradito' name='Reforzamiento' id='{{ student.kaid_student }}' draggable='true' ondragstart='start(event)' ondragend='end(event)'>{{ student.name }}</div>");
					{% endif%}
					{% if student.type == 'intermediate' %}
						$("#Intermedios").append("<div title='{{ student.name }}' class='cuadradito' name='Intermedios' id='{{ student.kaid_student }}' draggable='true' ondragstart='start(event)' ondragend='end(event)'>{{ student.name }}</div>");
					{% endif%}
					{% if student.type == 'advanced' %}
						$("#Avanzados").append("<div title='{{ student.name }}' class='cuadradito' name='Avanzados' id='{{ student.kaid_student }}' draggable='true' ondragstart='start(event)' ondragend='end(event)'>{{ student.name }}</div>");
					{% endif%}
				{% endfor %}
			{% endif %}	

			});
		</script>	


	<script>
		var topictree = JSON.parse('{{ topictree | escapejs }}');
		$('#topictree').on('changed.jstree', function (e, data) {
		    selected_skills=$('#topictree')
		    			.jstree()
		    			.get_bottom_selected(true);
		    selected_skills_id=new Array();
		    //Get selected skills (leaves of the topictree json)
		    for (i=0;i< selected_skills.length;i++){
		    	if (selected_skills[i].data){
		    		selected_skills_id.push(selected_skills[i].data["skill_id"]);
		    	}
		    }
		    //Remove duplicate skill id's in case they have been associated to more than one selected subskill
		    selected_skills_id = selected_skills_id.filter(
		    						function( item, index, inputArray ) {
										return inputArray.indexOf(item) == index;
									});
			$('input[name="skills"]').val(JSON.stringify(selected_skills_id));
	    }).jstree(topictree);
	    var to=false;
	    $('#skill_search').keyup(function () {
		    if(to) { clearTimeout(to); }
		    to = setTimeout(function () {
		      var v = $('#skill_search').val();
		      $('#topictree').jstree(true).search(v);
		    }, 250);
  		});
	</script>



{% endblock %}